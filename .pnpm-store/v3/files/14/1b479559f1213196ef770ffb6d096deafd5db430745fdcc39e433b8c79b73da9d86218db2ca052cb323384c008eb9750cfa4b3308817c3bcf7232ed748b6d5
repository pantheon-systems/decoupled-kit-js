{"version":3,"sources":["../../../src/steps/ingest-remote-schema/introspect-remote-schema.js"],"names":["getCachedRemoteIntrospectionDataCacheKey","state","store","getState","pluginOptions","gatsbyApi","INTROSPECTION_CACHE_KEY","url","getCachedRemoteIntrospectionData","introspectionData","key","remoteSchemaSupportsFieldNameOnTypeName","fieldName","typeName","type","__schema","types","find","name","fieldExists","fields","introspectAndStoreRemoteSchema","schemaWasChanged","remoteSchema","printSchemaDiff","debug","graphql","printIntrospectionDiff","preview","staleIntrospectionData","data","query","introspectionQuery","value","console","log","forEach","staleTypeJSON","JSON","stringify","newType","newTypeJSON","typeDiff","diff","diffJson","length","part","added","removed","chalk","green","bold","trim","split","map","line","index","join","typeMap","Map","dispatch","setState"],"mappings":"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","sourcesContent":["import chalk from \"chalk\"\nimport * as diff from \"diff\"\nimport { uniqBy } from \"lodash\"\nimport store from \"~/store\"\nimport { setPersistentCache, getPersistentCache } from \"~/utils/cache\"\nimport fetchGraphql from \"~/utils/fetch-graphql\"\nimport { introspectionQuery } from \"~/utils/graphql-queries\"\n\n/**\n * Builds the cache key for retrieving cached introspection data\n */\nconst getCachedRemoteIntrospectionDataCacheKey = () => {\n  const state = store.getState()\n  const { pluginOptions } = state.gatsbyApi\n\n  const INTROSPECTION_CACHE_KEY = `${pluginOptions.url}--introspection-data`\n\n  return INTROSPECTION_CACHE_KEY\n}\n\n/**\n * Returns cached introspection data for the remote WPGraphQL schema\n */\nconst getCachedRemoteIntrospectionData = async () => {\n  const INTROSPECTION_CACHE_KEY = getCachedRemoteIntrospectionDataCacheKey()\n  const introspectionData = await getPersistentCache({\n    key: INTROSPECTION_CACHE_KEY,\n  })\n\n  return introspectionData\n}\n\n/**\n * Checks if WPGraphQL is exposing a field on a type\n * for example `GatsbyPreviewData.manifestIds`\n * This allows us to make otherwise breaking changes in a backwards compatible way\n */\nexport const remoteSchemaSupportsFieldNameOnTypeName = async ({\n  fieldName,\n  typeName,\n}) => {\n  const introspectionData = await getCachedRemoteIntrospectionData()\n\n  const type = introspectionData.__schema.types.find(\n    ({ name }) => name === typeName\n  )\n\n  const fieldExists = !!type?.fields?.find(({ name }) => name === fieldName)\n\n  return fieldExists\n}\n\nconst introspectAndStoreRemoteSchema = async () => {\n  const state = store.getState()\n  const { pluginOptions } = state.gatsbyApi\n  const { schemaWasChanged } = state.remoteSchema\n\n  let introspectionData = await getCachedRemoteIntrospectionData()\n\n  const printSchemaDiff =\n    pluginOptions?.debug?.graphql?.printIntrospectionDiff ||\n    pluginOptions?.debug?.preview\n\n  let staleIntrospectionData\n\n  if (!introspectionData || schemaWasChanged) {\n    const { data } = await fetchGraphql({\n      query: introspectionQuery,\n    })\n\n    if (introspectionData) {\n      staleIntrospectionData = introspectionData\n    }\n\n    introspectionData = data\n\n    const INTROSPECTION_CACHE_KEY = getCachedRemoteIntrospectionDataCacheKey()\n\n    // cache introspection response\n    await setPersistentCache({\n      key: INTROSPECTION_CACHE_KEY,\n      value: introspectionData,\n    })\n  }\n\n  if (staleIntrospectionData && printSchemaDiff) {\n    console.log(`\\nData changed in WordPress schema:`)\n    staleIntrospectionData.__schema.types.forEach(type => {\n      const staleTypeJSON = JSON.stringify(type, null, 2)\n\n      const newType = introspectionData.__schema.types.find(\n        ({ name }) => name === type.name\n      )\n      const newTypeJSON = JSON.stringify(newType, null, 2)\n\n      if (staleTypeJSON === newTypeJSON) {\n        return\n      }\n\n      const typeDiff =\n        type && newType ? uniqBy(diff.diffJson(type, newType), `value`) : null\n\n      if (typeDiff?.length) {\n        console.log(`\\nFound changes to the ${type.name} type\\n`)\n        typeDiff.forEach(part => {\n          if (part.added || part.removed) {\n            console.log(\n              chalk.green(\n                chalk.bold(`${part.added ? `Added` : `Removed`}:\\n`) +\n                  part.value\n                    .trim()\n                    .split(`\\n`)\n                    .map(\n                      (line, index) =>\n                        `${part.added ? `+` : `-`}${\n                          index === 0 ? `\\t` : ` `\n                        }${line}`\n                    )\n                    .join(`\\n`)\n              )\n            )\n          }\n        })\n        console.log(`\\n`)\n      }\n    })\n  }\n\n  const typeMap = new Map(\n    introspectionData.__schema.types.map(type => [type.name, type])\n  )\n\n  store.dispatch.remoteSchema.setState({ introspectionData, typeMap })\n}\n\nexport { introspectAndStoreRemoteSchema }\n"],"file":"introspect-remote-schema.js"}