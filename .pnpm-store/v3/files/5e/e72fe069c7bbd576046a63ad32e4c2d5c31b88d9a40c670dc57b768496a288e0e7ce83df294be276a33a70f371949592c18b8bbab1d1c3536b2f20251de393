{"version":3,"sources":["../../src/utils/express-middlewares.ts"],"names":["configureTrailingSlash","getState","option","req","res","next","method","toLocaleLowerCase","includes","path","split","pop","length","page","slice","query","url","redirect","BASE","urlToMessWith","URL","pathname","toString","replace"],"mappings":";;;;;AAGA;;AAEO,MAAMA,sBAAsB,GACjC,CAACC,QAAD,EAA+BC,MAA/B,KACA,CACEC,GADF,EAEEC,GAFF,EAGEC,IAHF,KAIW;AAAA;;AACT,QAAMC,MAAM,GAAGH,GAAG,CAACG,MAAJ,CAAWC,iBAAX,EAAf;;AACA,MAAI,CAAC,CAAE,KAAF,EAAS,MAAT,EAAgBC,QAAhB,CAAyBF,MAAzB,CAAL,EAAuC;AACrCD,IAAAA,IAAI;AACJ;AACD;;AAED,MAAIF,GAAJ,aAAIA,GAAJ,kCAAIA,GAAG,CAAEM,IAAL,CAAUC,KAAV,CAAiB,GAAjB,CAAJ,mEAAI,gBAAsBC,GAAtB,EAAJ,gDAAI,oBAA6BH,QAA7B,CAAuC,GAAvC,CAAJ,EAAgD;AAC9C;AACAH,IAAAA,IAAI;AACJ;AACD;;AAED,MAAIF,GAAG,CAACM,IAAJ,CAASG,MAAT,IAAmB,CAAvB,EAA0B;AACxBP,IAAAA,IAAI;AACJ;AACD,GAhBQ,CAkBT;;;AACA,QAAMQ,IAAI,GAAG,oCAAeZ,QAAQ,EAAvB,EAA2BE,GAAG,CAACM,IAA/B,CAAb;;AAEA,MAAII,IAAJ,EAAU;AACR,QAAIX,MAAM,KAAM,OAAhB,EAAwB;AACtB,UAAIC,GAAG,CAACM,IAAJ,CAASK,KAAT,CAAe,CAAC,CAAhB,MAAwB,GAAxB,IAA8BD,IAAI,CAACJ,IAAL,KAAcN,GAAG,CAACM,IAApD,EAA0D;AACxD;AACA,cAAMM,KAAK,GAAGZ,GAAG,CAACa,GAAJ,CAAQF,KAAR,CAAcX,GAAG,CAACM,IAAJ,CAASG,MAAvB,CAAd;AACAR,QAAAA,GAAG,CAACa,QAAJ,CAAa,GAAb,EAAkBd,GAAG,CAACM,IAAJ,CAASK,KAAT,CAAe,CAAf,EAAkB,CAAC,CAAnB,IAAwBC,KAA1C;AACA;AACD,OALD,MAKO;AACL;AACA;AACA;AACA;AACA,cAAMG,IAAI,GAAI,kBAAd;AACA,cAAMC,aAAa,GAAG,IAAIC,GAAJ,CAAQjB,GAAG,CAACa,GAAZ,EAAiBE,IAAjB,CAAtB;AACAC,QAAAA,aAAa,CAACE,QAAd,IAA2B,GAA3B,CAPK,CASL;AACA;;AACAlB,QAAAA,GAAG,CAACa,GAAJ,GAAUG,aAAa,CAACG,QAAd,GAAyBC,OAAzB,CAAiCL,IAAjC,EAAwC,EAAxC,CAAV;AACD;AACF,KAnBD,MAmBO,IAAIhB,MAAM,KAAM,QAAhB,EAAyB;AAC9B,UAAIC,GAAG,CAACM,IAAJ,CAASK,KAAT,CAAe,CAAC,CAAhB,MAAwB,GAAxB,IAA8BD,IAAI,CAACJ,IAAL,KAAcN,GAAG,CAACM,IAApD,EAA0D;AACxD;AACA,cAAMM,KAAK,GAAGZ,GAAG,CAACa,GAAJ,CAAQF,KAAR,CAAcX,GAAG,CAACM,IAAJ,CAASG,MAAvB,CAAd;AACAR,QAAAA,GAAG,CAACa,QAAJ,CAAa,GAAb,EAAmB,GAAEd,GAAG,CAACM,IAAK,IAAGM,KAAM,EAAvC;AACA;AACD;AACF;AACF;;AAEDV,EAAAA,IAAI;AACL,CA1DI","sourcesContent":["import type { TrailingSlash } from \"gatsby-page-utils\"\nimport express from \"express\"\nimport type { IGatsbyState } from \"../redux/types\"\nimport { findPageByPath } from \"./find-page-by-path\"\n\nexport const configureTrailingSlash =\n  (getState: () => IGatsbyState, option: TrailingSlash | undefined) =>\n  (\n    req: express.Request,\n    res: express.Response,\n    next: express.NextFunction\n  ): void => {\n    const method = req.method.toLocaleLowerCase()\n    if (![`get`, `head`].includes(method)) {\n      next()\n      return\n    }\n\n    if (req?.path.split(`/`)?.pop()?.includes(`.`)) {\n      // Path has an extension. Do not add slash.\n      next()\n      return\n    }\n\n    if (req.path.length <= 1) {\n      next()\n      return\n    }\n\n    // check if it's Gatsby Page\n    const page = findPageByPath(getState(), req.path)\n\n    if (page) {\n      if (option === `never`) {\n        if (req.path.slice(-1) === `/` && page.path !== req.path) {\n          // Remove trailing slash\n          const query = req.url.slice(req.path.length)\n          res.redirect(301, req.path.slice(0, -1) + query)\n          return\n        } else {\n          // express.static really doesn't like paths without trailing slashes\n          // so we \"rewrite\" request to look like request with trailing slash\n          // otherwise we'll have an infinite redirect loop. We did this because\n          // express.static automatically adds the redirect trailing slash then\n          const BASE = `http://localhost`\n          const urlToMessWith = new URL(req.url, BASE)\n          urlToMessWith.pathname += `/`\n\n          // The incoming req.url is relative, so we remove the base again\n          // we use new URL so that queries/hashes are handled automatically\n          req.url = urlToMessWith.toString().replace(BASE, ``)\n        }\n      } else if (option === `always`) {\n        if (req.path.slice(-1) !== `/` && page.path !== req.path) {\n          // Add trailing slash\n          const query = req.url.slice(req.path.length)\n          res.redirect(301, `${req.path}/${query}`)\n          return\n        }\n      }\n    }\n\n    next()\n  }\n"],"file":"express-middlewares.js"}