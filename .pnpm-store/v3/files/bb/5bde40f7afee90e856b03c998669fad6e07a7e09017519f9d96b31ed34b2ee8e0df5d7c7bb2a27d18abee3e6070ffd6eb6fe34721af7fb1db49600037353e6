{"version":3,"sources":["../../../src/utils/dev-ssr/render-dev-html-child.js"],"names":["require","install","sysPath","fs","slash","getPosition","stackObject","filename","line","column","filteredStack","filter","s","test","splitLine","length","match","split","splitLength","Number","err","parseError","directory","componentPath","stack","position","join","sep","slice","sourceContent","readFileSync","e","trueFileName","includes","relative","message","exports","renderHTML","path","htmlComponentRendererPath","publicDir","isClientOnlyPage","error","undefined","Promise","resolve","reject","htmlComponentRenderer","process","env","GATSBY_EXPERIMENTAL_DEV_SSR","default","_throwAway","htmlString","catch","deleteModuleCache","cache"],"mappings":"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","sourcesContent":["require(`source-map-support`).install()\nconst sysPath = require(`path`)\nconst fs = require(`fs-extra`)\nconst { slash } = require(`gatsby-core-utils`)\n\nconst getPosition = function (stackObject) {\n  let filename\n  let line\n  let column\n  // Because the JavaScript error stack has not yet been standardized,\n  // wrap the stack parsing in a try/catch for a soft fail if an\n  // unexpected stack is encountered.\n  try {\n    const filteredStack = stackObject.filter(function (s) {\n      return /\\(.+?\\)$/.test(s)\n    })\n    let splitLine\n    // For current Node & Chromium Error stacks\n    if (filteredStack.length > 0) {\n      splitLine = filteredStack[0].match(/(?:\\()(.+?)(?:\\))$/)[1].split(`:`)\n      // For older, future, or otherwise unexpected stacks\n    } else {\n      splitLine = stackObject[0].split(`:`)\n    }\n    const splitLength = splitLine.length\n    filename = splitLine[splitLength - 3]\n    line = Number(splitLine[splitLength - 2])\n    column = Number(splitLine[splitLength - 1])\n  } catch (err) {\n    filename = ``\n    line = 0\n    column = 0\n  }\n  return {\n    filename,\n    line,\n    column,\n  }\n}\n\n// Code borrowed and modified from https://github.com/watilde/parse-error\nconst parseError = function ({ err, directory, componentPath }) {\n  const stack = err.stack ? err.stack : ``\n  const stackObject = stack.split(`\\n`)\n  const position = getPosition(stackObject)\n\n  // Remove the `/lib/` added by webpack\n  const filename = sysPath.join(\n    directory,\n    // Don't need to use path.sep as webpack always uses a single forward slash\n    // as a path separator.\n    ...position.filename.split(sysPath.sep).slice(2)\n  )\n\n  let sourceContent\n  try {\n    sourceContent = fs.readFileSync(filename, `utf-8`)\n  } catch (e) {\n    sourceContent = null\n  }\n\n  // We prefer the file path from the stack trace as the error might not be in the\n  // component â€” but if source-maps fail and we just get public/render-page.js as\n  // the file, we fall back on the component filepath as at least the user\n  // will have that.\n  const trueFileName = filename.includes(`render-page`)\n    ? componentPath\n    : filename\n\n  return {\n    filename: slash(sysPath.relative(directory, trueFileName)),\n    sourceContent,\n    message: err.message,\n    stack: stack,\n    line: position.line,\n    column: position.column,\n  }\n}\n\nexports.parseError = parseError\n\nexports.renderHTML = ({\n  path,\n  componentPath,\n  htmlComponentRendererPath,\n  publicDir,\n  isClientOnlyPage = false,\n  error = undefined,\n  directory,\n}) =>\n  new Promise((resolve, reject) => {\n    try {\n      const htmlComponentRenderer = require(htmlComponentRendererPath)\n      if (process.env.GATSBY_EXPERIMENTAL_DEV_SSR) {\n        htmlComponentRenderer\n          .default(\n            path,\n            isClientOnlyPage,\n            publicDir,\n            error,\n            (_throwAway, htmlString) => {\n              resolve(htmlString)\n            }\n          )\n          .catch(err => {\n            const error = parseError({ err, directory, componentPath })\n            reject(error)\n          })\n      } else {\n        htmlComponentRenderer.default(path, (_throwAway, htmlString) => {\n          resolve(htmlString)\n        })\n      }\n    } catch (err) {\n      const error = parseError({ err, directory, componentPath })\n      reject(error)\n    }\n  })\n\nexports.deleteModuleCache = htmlComponentRendererPath => {\n  delete require.cache[require.resolve(htmlComponentRendererPath)]\n}\n"],"file":"render-dev-html-child.js"}