{"version":3,"sources":["../../src/utils/develop-proxy.ts"],"names":["noop","startDevelopProxy","input","shouldServeRestartingScreen","proxy","httpProxy","createProxyServer","target","targetPort","changeOrigin","preserveHeaderKeyCase","autoRewrite","ws","on","app","req","res","url","program","directory","then","services","setHeader","end","JSON","stringify","fs","readFileSync","require","resolve","restartingScreen","web","server","ssl","https","createServer","http","socket","head","listen","proxyPort","host","serveRestartingScreen","serveSite"],"mappings":";;;;;;;AAAA;;AACA;;AACA;;AACA;;AACA;;AACA;;AASA,MAAMA,IAAI,GAAG,MAAY,CAAE,CAA3B;;AAEO,MAAMC,iBAAiB,GAAIC,KAAD,IAIX;AACpB,MAAIC,2BAA2B,GAAG,KAAlC;;AAEA,QAAMC,KAAK,GAAGC,mBAAUC,iBAAV,CAA4B;AACxCC,IAAAA,MAAM,EAAG,oBAAmBL,KAAK,CAACM,UAAW,EADL;AAExCC,IAAAA,YAAY,EAAE,IAF0B;AAGxCC,IAAAA,qBAAqB,EAAE,IAHiB;AAIxCC,IAAAA,WAAW,EAAE,IAJ2B;AAKxCC,IAAAA,EAAE,EAAE;AALoC,GAA5B,CAAd,CAHoB,CAWpB;AACA;;;AACAR,EAAAA,KAAK,CAACS,EAAN,CAAU,OAAV,EAAkBb,IAAlB;;AAEA,QAAMc,GAAyB,GAAG,CAACC,GAAD,EAAMC,GAAN,KAAoB;AACpD;AACA,QAAID,GAAG,CAACE,GAAJ,KAAa,cAAjB,EAAgC;AAC9B,wCAAYf,KAAK,CAACgB,OAAN,CAAcC,SAA1B,EAAqCC,IAArC,CAA0CC,QAAQ,IAAI;AACpDL,QAAAA,GAAG,CAACM,SAAJ,CAAe,cAAf,EAA+B,kBAA/B;AACAN,QAAAA,GAAG,CAACO,GAAJ,CAAQC,IAAI,CAACC,SAAL,CAAeJ,QAAf,CAAR;AACD,OAHD;AAIA;AACD;;AAED,QAAIN,GAAG,CAACE,GAAJ,KAAa,yBAAjB,EAA2C;AACzCD,MAAAA,GAAG,CAACM,SAAJ,CAAe,cAAf,EAA+B,wBAA/B;AACAN,MAAAA,GAAG,CAACO,GAAJ,CACEG,iBAAGC,YAAH,CAAgBC,OAAO,CAACC,OAAR,CAAiB,oCAAjB,CAAhB,CADF;AAGA;AACD;;AAED,QACE1B,2BAA2B,IAC3BY,GAAG,CAACE,GAAJ,KAAa,6BAFf,EAGE;AACAD,MAAAA,GAAG,CAACO,GAAJ,CAAQO,yBAAR;AACA;AACD;;AAED1B,IAAAA,KAAK,CAAC2B,GAAN,CAAUhB,GAAV,EAAeC,GAAf;AACD,GA3BD;;AA6BA,QAAMgB,MAAM,GAAG9B,KAAK,CAACgB,OAAN,CAAce,GAAd,GACXC,eAAMC,YAAN,CAAmBjC,KAAK,CAACgB,OAAN,CAAce,GAAjC,EAAsCnB,GAAtC,CADW,GAEXsB,cAAKD,YAAL,CAAkBrB,GAAlB,CAFJ;AAIAkB,EAAAA,MAAM,CAACnB,EAAP,CAAW,SAAX,EAAqB,UAAUE,GAAV,EAAesB,MAAf,EAAuBC,IAAvB,EAA6B;AAChDlC,IAAAA,KAAK,CAACQ,EAAN,CAASG,GAAT,EAAcsB,MAAd,EAAsBC,IAAtB;AACD,GAFD;AAIAN,EAAAA,MAAM,CAACO,MAAP,CAAcrC,KAAK,CAACsC,SAApB,EAA+BtC,KAAK,CAACgB,OAAN,CAAcuB,IAA7C;AAEA,SAAO;AACLT,IAAAA,MADK;AAELU,IAAAA,qBAAqB,EAAE,MAAY;AACjCvC,MAAAA,2BAA2B,GAAG,IAA9B;AACD,KAJI;AAKLwC,IAAAA,SAAS,EAAE,MAAY;AACrBxC,MAAAA,2BAA2B,GAAG,KAA9B;AACD;AAPI,GAAP;AASD,CAnEM","sourcesContent":["import http from \"http\"\nimport https from \"https\"\nimport httpProxy from \"http-proxy\"\nimport fs from \"fs-extra\"\nimport { getServices } from \"gatsby-core-utils\"\nimport restartingScreen from \"./restarting-screen\"\nimport { IProgram } from \"../commands/types\"\n\nexport interface IProxyControls {\n  serveRestartingScreen: () => void\n  serveSite: () => void\n  server: https.Server | http.Server\n}\n\nconst noop = (): void => {}\n\nexport const startDevelopProxy = (input: {\n  proxyPort: number\n  targetPort: number\n  program: IProgram\n}): IProxyControls => {\n  let shouldServeRestartingScreen = false\n\n  const proxy = httpProxy.createProxyServer({\n    target: `http://localhost:${input.targetPort}`,\n    changeOrigin: true,\n    preserveHeaderKeyCase: true,\n    autoRewrite: true,\n    ws: true,\n  })\n\n  // Noop on proxy errors, as this throws a bunch of \"Socket hang up\"\n  // ones whenever the page is refreshed\n  proxy.on(`error`, noop)\n\n  const app: http.RequestListener = (req, res): void => {\n    // Add a route at localhost:8000/___services for service discovery\n    if (req.url === `/___services`) {\n      getServices(input.program.directory).then(services => {\n        res.setHeader(`Content-Type`, `application/json`)\n        res.end(JSON.stringify(services))\n      })\n      return\n    }\n\n    if (req.url === `/socket.io/socket.io.js`) {\n      res.setHeader(`Content-Type`, `application/javascript`)\n      res.end(\n        fs.readFileSync(require.resolve(`socket.io-client/dist/socket.io.js`))\n      )\n      return\n    }\n\n    if (\n      shouldServeRestartingScreen ||\n      req.url === `/___debug-restarting-screen`\n    ) {\n      res.end(restartingScreen)\n      return\n    }\n\n    proxy.web(req, res)\n  }\n\n  const server = input.program.ssl\n    ? https.createServer(input.program.ssl, app)\n    : http.createServer(app)\n\n  server.on(`upgrade`, function (req, socket, head) {\n    proxy.ws(req, socket, head)\n  })\n\n  server.listen(input.proxyPort, input.program.host)\n\n  return {\n    server,\n    serveRestartingScreen: (): void => {\n      shouldServeRestartingScreen = true\n    },\n    serveSite: (): void => {\n      shouldServeRestartingScreen = false\n    },\n  }\n}\n"],"file":"develop-proxy.js"}