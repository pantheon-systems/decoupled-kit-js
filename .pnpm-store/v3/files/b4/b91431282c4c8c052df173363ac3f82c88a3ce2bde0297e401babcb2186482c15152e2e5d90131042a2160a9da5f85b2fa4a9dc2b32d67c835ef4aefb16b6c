{"version":3,"sources":["../../src/utils/babel-loader.js"],"names":["babelLoader","require","prepareOptions","getCustomOptions","mergeConfigItemOptions","addRequiredPresetOptions","getBrowsersList","customOptionsCache","Map","configCache","babelrcFileToCacheKey","module","exports","custom","babel","customOptions","stage","reactRuntime","reactImportSource","isPageTemplate","rootDir","process","cwd","options","customOptionsCacheKey","has","get","toReturn","loader","cacheIdentifier","JSON","stringify","browsersList","version","gatsbyPreset","env","getEnv","sourceType","set","config","partialConfig","configCacheKey","hasFilesystemConfig","files","forEach","configFilePath","cacheKeysToInvalidate","Set","add","reduxPresets","reduxPlugins","requiredPresets","requiredPlugins","fallbackPresets","plugins","presets","preset","items","itemToMerge","type","plugin","BabelConfigItemsCacheInvalidatorPlugin","constructor","name","apply","compiler","hooks","invalid","tap","file","cacheKey","delete"],"mappings":"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","sourcesContent":["const babelLoader = require(`babel-loader`)\n\nconst {\n  prepareOptions,\n  getCustomOptions,\n  mergeConfigItemOptions,\n  addRequiredPresetOptions,\n} = require(`./babel-loader-helpers`)\nconst { getBrowsersList } = require(`./browserslist`)\n\n/**\n * Gatsby's custom loader for webpack & babel\n *\n * Gatsby allows sites to either use our Babel setup (the default)\n * or to add a .babelrc to take control.\n *\n * Our default setup is defined in the fallbackPlugins/fallbackPresets arrays\n * below.\n *\n * After using either the fallback or user supplied setup, we add on a handful\n * of required plugins and finally merge in any presets/plugins supplied\n * by Gatsby plugins.\n *\n * You can find documentation for the custom loader here: https://babeljs.io/docs/en/next/babel-core.html#loadpartialconfig\n */\n\nconst customOptionsCache = new Map()\nconst configCache = new Map()\nconst babelrcFileToCacheKey = new Map()\n\nmodule.exports = babelLoader.custom(babel => {\n  return {\n    // Passed the loader options.\n    customOptions({\n      stage = `test`,\n      reactRuntime = `classic`,\n      reactImportSource,\n      isPageTemplate,\n      rootDir = process.cwd(),\n      ...options\n    }) {\n      const customOptionsCacheKey = `${stage}-${isPageTemplate}`\n\n      if (customOptionsCache.has(customOptionsCacheKey)) {\n        return customOptionsCache.get(customOptionsCacheKey)\n      }\n\n      const toReturn = {\n        custom: {\n          stage,\n          reactRuntime,\n          reactImportSource,\n          isPageTemplate,\n        },\n        loader: {\n          cacheIdentifier: JSON.stringify({\n            browsersList: getBrowsersList(rootDir),\n            babel: babel.version,\n            gatsbyPreset: require(`babel-preset-gatsby/package.json`).version,\n            env: babel.getEnv(),\n          }),\n          sourceType: `unambiguous`,\n          ...getCustomOptions(stage),\n          ...options,\n        },\n      }\n\n      customOptionsCache.set(customOptionsCacheKey, toReturn)\n\n      return toReturn\n    },\n\n    // Passed Babel's 'PartialConfig' object.\n    config(partialConfig, { customOptions }) {\n      const { stage, isPageTemplate } = customOptions\n      let configCacheKey = `${stage}-${isPageTemplate}`\n\n      if (partialConfig.hasFilesystemConfig()) {\n        // partialConfig.files is a Set that accumulates used config files (absolute paths)\n        partialConfig.files.forEach(configFilePath => {\n          configCacheKey += `_${configFilePath}`\n        })\n\n        // after generating configCacheKey add link between babelrc files and cache keys that rely on it\n        // so we can invalidate memoized configs when used babelrc file changes\n        partialConfig.files.forEach(configFilePath => {\n          let cacheKeysToInvalidate = babelrcFileToCacheKey.get(configFilePath)\n          if (!cacheKeysToInvalidate) {\n            cacheKeysToInvalidate = new Set()\n            babelrcFileToCacheKey.set(configFilePath, cacheKeysToInvalidate)\n          }\n\n          cacheKeysToInvalidate.add(configCacheKey)\n        })\n      }\n\n      let { options } = partialConfig\n      if (configCache.has(configCacheKey)) {\n        return { ...options, ...configCache.get(configCacheKey) }\n      }\n\n      const [\n        reduxPresets,\n        reduxPlugins,\n        requiredPresets,\n        requiredPlugins,\n        fallbackPresets,\n      ] = prepareOptions(babel, customOptions)\n\n      // If there is no filesystem babel config present, add our fallback\n      // presets/plugins.\n      if (!partialConfig.hasFilesystemConfig()) {\n        options = {\n          ...options,\n          plugins: requiredPlugins,\n          presets: [...fallbackPresets, ...requiredPresets],\n        }\n      } else {\n        // With a babelrc present, only add our required plugins/presets\n        options = {\n          ...options,\n          plugins: [...options.plugins, ...requiredPlugins],\n          presets: [...options.presets, ...requiredPresets],\n        }\n        // User-defined preset likely contains `babel-preset-gatsby`\n        // Make sure to pass required dynamic options (e.g. `stage` to it):\n        addRequiredPresetOptions(babel, options.presets, customOptions)\n      }\n\n      // Merge in presets/plugins added from gatsby plugins.\n      reduxPresets.forEach(preset => {\n        options.presets = mergeConfigItemOptions({\n          items: options.presets,\n          itemToMerge: preset,\n          type: `preset`,\n          babel,\n        })\n      })\n\n      reduxPlugins.forEach(plugin => {\n        options.plugins = mergeConfigItemOptions({\n          items: options.plugins,\n          itemToMerge: plugin,\n          type: `plugin`,\n          babel,\n        })\n      })\n\n      // cache just plugins and presets, because config also includes things like\n      // filenames - this is mostly to not call `mergeConfigItemOptions` for each file\n      // as that function call `babel.createConfigItem` and is quite expensive but also\n      // skips quite a few nested loops on top of that\n      configCache.set(configCacheKey, {\n        plugins: options.plugins,\n        presets: options.presets,\n      })\n\n      return options\n    },\n  }\n})\n\nmodule.exports.BabelConfigItemsCacheInvalidatorPlugin = class BabelConfigItemsCacheInvalidatorPlugin {\n  constructor() {\n    this.name = `BabelConfigItemsCacheInvalidatorPlugin`\n  }\n\n  apply(compiler) {\n    compiler.hooks.invalid.tap(this.name, function (file) {\n      const cacheKeysToInvalidate = babelrcFileToCacheKey.get(file)\n\n      if (cacheKeysToInvalidate) {\n        for (const cacheKey of cacheKeysToInvalidate) {\n          configCache.delete(cacheKey)\n        }\n        babelrcFileToCacheKey.delete(file)\n      }\n    })\n  }\n}\n"],"file":"babel-loader.js"}