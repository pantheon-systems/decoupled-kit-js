{"version":3,"sources":["../../src/utils/show-experiment-notice.ts"],"names":["ONE_DAY","noticesToShow","configStoreKey","experimentIdentifier","showExperimentNoticeAfterTimeout","umbrellaLink","noticeText","showNoticeAfterMs","minimumIntervalBetweenNoticesMs","lastTimeWeShowedNotice","get","Date","now","undefined","noticeTimeout","setTimeout","push","clearNoticeTimeout","clearTimeout","createNoticeMessage","notices","message","forEach","notice","chalk","bgBlue","bold","showExperimentNotices","length","telemetry","trackCli","set","reporter","info"],"mappings":";;;;;;;;AAAA;;AACA;;AACA;;AACA;;AAQA,MAAMA,OAAO,GAAG,KAAK,EAAL,GAAU,EAAV,GAAe,IAA/B;AAQA,MAAMC,aAAmC,GAAG,EAA5C;;AACA,MAAMC,cAAc,GAAIC,oBAAD,IACpB,wBAAuBA,oBAAqB,EAD/C;;AAGO,SAASC,gCAAT,CACLD,oBADK,EAELE,YAFK,EAGLC,UAHK,EAILC,iBAJK,EAKLC,+BAAuC,GAAGR,OALrC,EAMsC;AAC3C,QAAMS,sBAAsB,GAAG,uCAAiBC,GAAjB,CAC7BR,cAAc,CAACC,oBAAD,CADe,CAA/B;;AAIA,MAAIM,sBAAJ,EAA4B;AAC1B,QAAIE,IAAI,CAACC,GAAL,KAAaH,sBAAb,GAAsCD,+BAA1C,EAA2E;AACzE,aAAOK,SAAP;AACD;AACF;;AAED,QAAMC,aAAa,GAAGC,UAAU,CAAC,MAAM;AACrCd,IAAAA,aAAa,CAACe,IAAd,CAAmB;AAAEV,MAAAA,UAAF;AAAcD,MAAAA,YAAd;AAA4BF,MAAAA;AAA5B,KAAnB;AACD,GAF+B,EAE7BI,iBAF6B,CAAhC;AAIA,SAAO,SAASU,kBAAT,GAAoC;AACzCC,IAAAA,YAAY,CAACJ,aAAD,CAAZ;AACD,GAFD;AAGD;;AAEM,MAAMK,mBAAmB,GAAIC,OAAD,IAAqB;AACtD,MAAIC,OAAO,GAAI;AACjB;AACA,sBAFE;AAIAD,EAAAA,OAAO,CAACE,OAAR,CACEC,MAAM,IACHF,OAAO,IAAK;AACnB;AACA,EAAEG,eAAMC,MAAN,CAAaC,IAAb,CAAkBH,MAAM,CAACpB,oBAAzB,CAA+C,KAAIoB,MAAM,CAAClB,YAAa,MACjEkB,MAAM,CAACjB,UACR,IANL;AASA,SAAOe,OAAP;AACD,CAfM;;;;AAiBA,MAAMM,qBAAqB,GAAG,MAAY;AAC/C,MAAI1B,aAAa,CAAC2B,MAAd,GAAuB,CAA3B,EAA8B;AAC5BC,6BAAUC,QAAV,CAAoB,uBAApB,EAD4B,CAE5B;;;AACA7B,IAAAA,aAAa,CAACqB,OAAd,CAAsBC,MAAM,IAC1B,uCAAiBQ,GAAjB,CACE7B,cAAc,CAACqB,MAAM,CAACpB,oBAAR,CADhB,EAEEQ,IAAI,CAACC,GAAL,EAFF,CADF;AAOA,UAAMS,OAAO,GAAGF,mBAAmB,CAAClB,aAAD,CAAnC;;AACA+B,sBAASC,IAAT,CAAcZ,OAAd;AACD;AACF,CAdM","sourcesContent":["import { getConfigStore } from \"gatsby-core-utils\"\nimport reporter from \"gatsby-cli/lib/reporter\"\nimport chalk from \"chalk\"\nimport telemetry from \"gatsby-telemetry\"\n\ntype CancelExperimentNoticeCallback = () => void\n\nexport type CancelExperimentNoticeCallbackOrUndefined =\n  | CancelExperimentNoticeCallback\n  | undefined\n\nconst ONE_DAY = 24 * 60 * 60 * 1000\n\ninterface INoticeObject {\n  noticeText: string\n  umbrellaLink: string\n  experimentIdentifier: string\n}\n\nconst noticesToShow: Array<INoticeObject> = []\nconst configStoreKey = (experimentIdentifier): string =>\n  `lastExperimentNotice.${experimentIdentifier}`\n\nexport function showExperimentNoticeAfterTimeout(\n  experimentIdentifier: string,\n  umbrellaLink: string,\n  noticeText: string,\n  showNoticeAfterMs: number,\n  minimumIntervalBetweenNoticesMs: number = ONE_DAY\n): CancelExperimentNoticeCallbackOrUndefined {\n  const lastTimeWeShowedNotice = getConfigStore().get(\n    configStoreKey(experimentIdentifier)\n  )\n\n  if (lastTimeWeShowedNotice) {\n    if (Date.now() - lastTimeWeShowedNotice < minimumIntervalBetweenNoticesMs) {\n      return undefined\n    }\n  }\n\n  const noticeTimeout = setTimeout(() => {\n    noticesToShow.push({ noticeText, umbrellaLink, experimentIdentifier })\n  }, showNoticeAfterMs)\n\n  return function clearNoticeTimeout(): void {\n    clearTimeout(noticeTimeout)\n  }\n}\n\nexport const createNoticeMessage = (notices): string => {\n  let message = `\\nHi from the Gatsby maintainers! Based on what we see in your site, these coming\nfeatures may help you. All of these can be enabled within gatsby-config.js via\nflags (samples below)`\n\n  notices.forEach(\n    notice =>\n      (message += `\n\n${chalk.bgBlue.bold(notice.experimentIdentifier)} (${notice.umbrellaLink}), ${\n        notice.noticeText\n      }\\n`)\n  )\n\n  return message\n}\n\nexport const showExperimentNotices = (): void => {\n  if (noticesToShow.length > 0) {\n    telemetry.trackCli(`InviteToTryExperiment`)\n    // Store that we're showing the invite.\n    noticesToShow.forEach(notice =>\n      getConfigStore().set(\n        configStoreKey(notice.experimentIdentifier),\n        Date.now()\n      )\n    )\n\n    const message = createNoticeMessage(noticesToShow)\n    reporter.info(message)\n  }\n}\n"],"file":"show-experiment-notice.js"}