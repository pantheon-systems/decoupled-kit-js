{"version":3,"sources":["../../src/utils/start-server.ts"],"names":["startServer","program","app","workerPool","WorkerPool","create","directory","PAGE_RENDERER_PATH","path","join","ROUTES_DIRECTORY","webpackActivity","report","activityTimer","id","start","directoryPath","buildRenderer","doBuildPages","require","createIndexHtml","activity","rendererPath","close","Stage","DevelopHTML","span","err","name","panic","stripIndent","indexHTMLActivity","phantomActivity","pageRenderer","process","env","GATSBY_EXPERIMENTAL_DEV_SSR","initDevWorkerPool","end","devConfig","Develop","port","parentSpan","compiler","use","telemetry","expressMiddleware","log","heartbeat","graphqlEndpoint","GATSBY_GRAPHQL_IDE","get","endpoint","getFragments","fragments","def","store","getState","definitions","values","kind","Kind","FRAGMENT_DEFINITION","push","schema","schemaCustomization","composer","Error","graphiql","extensions","enableRefresh","ENABLE_GATSBY_REFRESH_ENDPOINT","refreshToken","GATSBY_REFRESH_TOKEN","context","schemaComposer","customContext","customFormatErrorFn","stack","split","REFRESH_ENDPOINT","refresh","req","pluginName","global","__GATSBY","buildId","uuid","v4","emitter","emit","webhookBody","body","post","express","json","res","params","authorizedRefresh","headers","authorization","status","setHeader","error","isEnabled","query","fileName","resolve","cwd","lineNumber","parseInt","isNaN","webpackDevMiddlewareInstance","publicPath","output","stats","serverSideRender","next","requestedPagePath","pagePath","potentialPagePath","page","serverDataPromise","Promise","pageMode","renderer","componentInstance","getPageChunk","catch","pageData","GATSBY_EXPERIMENTAL_QUERY_ON_DEMAND","Date","now","trackCli","duration","statusCode","result","value","Object","entries","serverData","props","getServerDataError","structuredError","panicOnBuild","sourceMessage","message","matchPath","send","e","compilation","locals","webpack","devMiddleware","emptyResponse","codeFrame","sourcePosition","sourceContent","moduleId","columnNumber","fileModule","module","modules","moduleIdentifier","chunkGraph","getModuleId","webpackSource","codeGenerationResults","sources","sourceMap","map","position","line","column","sourceLine","sourceColumn","highlightCode","filePath","fs","readFile","developMiddleware","config","proxy","trailingSlash","index","forEach","prefix","url","proxiedUrl","originalUrl","host","method","pipe","got","stream","decompress","on","response","writeHead","_","sendStatus","deferNodeMutation","trackFeatureIsUsed","pathObj","decodeURI","htmlActivity","renderResponse","skipSsr","prototype","hasOwnProperty","call","htmlComponentRendererPath","filename","source","clientOnlyShell","location","minimalHTML","GATSBY_QUERY_ON_DEMAND_LOADING_INDICATOR","fullUrl","protocol","endsWith","webpackCompilationHash","renderDevHTML","undefined","sendFile","server","http","Server","socket","websocketManager","init","listener","listen","chokidar","watchGlobs","watch","to","webpackWatching","watching"],"mappings":"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","sourcesContent":["import webpackHotMiddleware from \"@gatsbyjs/webpack-hot-middleware\"\nimport webpackDevMiddleware from \"webpack-dev-middleware\"\nimport got, { Method } from \"got\"\nimport webpack from \"webpack\"\nimport express from \"express\"\nimport compression from \"compression\"\nimport { graphqlHTTP, OptionsData } from \"express-graphql\"\nimport graphqlPlayground from \"graphql-playground-middleware-express\"\nimport graphiqlExplorer from \"gatsby-graphiql-explorer\"\nimport {\n  formatError,\n  FragmentDefinitionNode,\n  GraphQLFormattedError,\n  Kind,\n} from \"graphql\"\nimport { slash, uuid } from \"gatsby-core-utils\"\nimport http from \"http\"\nimport cors from \"cors\"\nimport telemetry from \"gatsby-telemetry\"\nimport launchEditor from \"react-dev-utils/launchEditor\"\nimport { codeFrameColumns } from \"@babel/code-frame\"\nimport * as fs from \"fs-extra\"\n\nimport { withBasePath } from \"../utils/path\"\nimport webpackConfig from \"../utils/webpack.config\"\nimport { store, emitter } from \"../redux\"\nimport report from \"gatsby-cli/lib/reporter\"\nimport * as WorkerPool from \"../utils/worker/pool\"\n\nimport { developStatic } from \"../commands/develop-static\"\nimport withResolverContext from \"../schema/context\"\nimport { websocketManager, WebsocketManager } from \"../utils/websocket-manager\"\nimport {\n  reverseFixedPagePath,\n  readPageData,\n  IPageDataWithQueryResult,\n} from \"./page-data\"\nimport { getPageData as getPageDataExperimental } from \"./get-page-data\"\nimport { findPageByPath } from \"./find-page-by-path\"\nimport apiRunnerNode from \"../utils/api-runner-node\"\nimport * as path from \"path\"\n\nimport { Stage, IProgram } from \"../commands/types\"\nimport { findOriginalSourcePositionAndContent } from \"./stack-trace-utils\"\nimport { appendPreloadHeaders } from \"./develop-preload-headers\"\nimport {\n  routeLoadingIndicatorRequests,\n  writeVirtualLoadingIndicatorModule,\n} from \"./loading-indicator\"\nimport { renderDevHTML } from \"./dev-ssr/render-dev-html\"\nimport { getServerData, IServerData } from \"./get-server-data\"\nimport { ROUTES_DIRECTORY } from \"../constants\"\nimport { getPageMode } from \"./page-mode\"\nimport { configureTrailingSlash } from \"./express-middlewares\"\nimport type { Express } from \"express\"\nimport { addImageRoutes } from \"gatsby-plugin-utils/polyfill-remote-file\"\n\ntype ActivityTracker = any // TODO: Replace this with proper type once reporter is typed\n\ninterface IServer {\n  compiler: webpack.Compiler\n  listener: http.Server\n  webpackActivity: ActivityTracker\n  websocketManager: WebsocketManager\n  workerPool: WorkerPool.GatsbyWorkerPool\n  webpackWatching: IWebpackWatchingPauseResume\n}\n\nexport interface IWebpackWatchingPauseResume {\n  suspend: () => void\n  resume: () => void\n}\n\nexport async function startServer(\n  program: IProgram,\n  app: Express,\n  workerPool: WorkerPool.GatsbyWorkerPool = WorkerPool.create()\n): Promise<IServer> {\n  const directory = program.directory\n  const PAGE_RENDERER_PATH = path.join(\n    program.directory,\n    ROUTES_DIRECTORY,\n    `render-page.js`\n  )\n\n  const webpackActivity = report.activityTimer(`Building development bundle`, {\n    id: `webpack-develop`,\n  })\n  webpackActivity.start()\n\n  // loading indicator\n  // write virtual module always to not fail webpack compilation, but only add express route handlers when\n  // query on demand is enabled and loading indicator is not disabled\n  writeVirtualLoadingIndicatorModule()\n\n  // Remove the following when merging GATSBY_EXPERIMENTAL_DEV_SSR\n  const directoryPath = withBasePath(directory)\n  const { buildRenderer, doBuildPages } = require(`../commands/build-html`)\n  const createIndexHtml = async (activity: ActivityTracker): Promise<void> => {\n    try {\n      const { rendererPath, close } = await buildRenderer(\n        program,\n        Stage.DevelopHTML,\n        activity.span\n      )\n      await doBuildPages(\n        rendererPath,\n        [`/`],\n        activity,\n        workerPool,\n        Stage.DevelopHTML\n      )\n      // close the compiler\n      await close()\n    } catch (err) {\n      if (err.name !== `WebpackError`) {\n        report.panic(err)\n        return\n      }\n      report.panic(\n        report.stripIndent`\n          There was an error compiling the html.js component for the development server.\n          See our docs page on debugging HTML builds for help https://gatsby.dev/debug-html\n        `,\n        err\n      )\n    }\n  }\n  const indexHTMLActivity = report.phantomActivity(`building index.html`, {})\n\n  let pageRenderer: string\n  if (process.env.GATSBY_EXPERIMENTAL_DEV_SSR) {\n    const { buildRenderer } = require(`../commands/build-html`)\n    pageRenderer = (await buildRenderer(program, Stage.DevelopHTML))\n      .rendererPath\n    const { initDevWorkerPool } = require(`./dev-ssr/render-dev-html`)\n    initDevWorkerPool()\n  } else {\n    indexHTMLActivity.start()\n\n    await createIndexHtml(indexHTMLActivity)\n\n    indexHTMLActivity.end()\n  }\n\n  const devConfig = await webpackConfig(\n    program,\n    directory,\n    Stage.Develop,\n    program.port,\n    {\n      parentSpan: webpackActivity.span,\n    }\n  )\n\n  const compiler = webpack(devConfig)\n\n  /**\n   * Set up the express app.\n   **/\n  app.use(compression())\n  app.use(telemetry.expressMiddleware(`DEVELOP`))\n  app.use(\n    webpackHotMiddleware(compiler, {\n      log: false,\n      path: `/__webpack_hmr`,\n      heartbeat: 10 * 1000,\n    })\n  )\n\n  app.use(cors())\n\n  /**\n   * Pattern matching all endpoints with graphql or graphiql with 1 or more leading underscores\n   */\n  const graphqlEndpoint = `/_+graphi?ql`\n\n  // TODO(v5): Remove GraphQL Playground (GraphiQL will be more future-proof)\n  if (process.env.GATSBY_GRAPHQL_IDE === `playground`) {\n    app.get(\n      graphqlEndpoint,\n      graphqlPlayground({\n        endpoint: `/___graphql`,\n      }),\n      () => {}\n    )\n  } else {\n    graphiqlExplorer(app, {\n      graphqlEndpoint,\n      getFragments: function getFragments(): Array<FragmentDefinitionNode> {\n        const fragments: Array<FragmentDefinitionNode> = []\n        for (const def of store.getState().definitions.values()) {\n          if (def.def.kind === Kind.FRAGMENT_DEFINITION) {\n            fragments.push(def.def)\n          }\n        }\n        return fragments\n      },\n    })\n  }\n\n  app.use(\n    graphqlEndpoint,\n    graphqlHTTP((): OptionsData => {\n      const { schema, schemaCustomization } = store.getState()\n\n      if (!schemaCustomization.composer) {\n        throw new Error(\n          `A schema composer was not created in time. This is likely a gatsby bug. If you experienced this please create an issue.`\n        )\n      }\n      return {\n        schema,\n        graphiql: false,\n        extensions(): { [key: string]: unknown } {\n          return {\n            enableRefresh: process.env.ENABLE_GATSBY_REFRESH_ENDPOINT,\n            refreshToken: process.env.GATSBY_REFRESH_TOKEN,\n          }\n        },\n        context: withResolverContext({\n          schema,\n          schemaComposer: schemaCustomization.composer,\n          context: {},\n          customContext: schemaCustomization.context,\n        }),\n        customFormatErrorFn(\n          err\n        ): GraphQLFormattedError<{ stack: Array<string> }> {\n          return {\n            ...formatError(err),\n            extensions: {\n              stack: err.stack ? err.stack.split(`\\n`) : [],\n            },\n          }\n        },\n      }\n    })\n  )\n\n  /**\n   * Refresh external data sources.\n   * This behavior is disabled by default, but the ENABLE_GATSBY_REFRESH_ENDPOINT env var enables it\n   * If no GATSBY_REFRESH_TOKEN env var is available, then no Authorization header is required\n   **/\n  const REFRESH_ENDPOINT = `/__refresh`\n  const refresh = async (\n    req: express.Request,\n    pluginName?: string\n  ): Promise<void> => {\n    global.__GATSBY.buildId = uuid.v4()\n\n    emitter.emit(`WEBHOOK_RECEIVED`, {\n      webhookBody: req.body,\n      pluginName,\n    })\n  }\n\n  app.post(`${REFRESH_ENDPOINT}/:plugin_name?`, express.json(), (req, res) => {\n    const pluginName = req.params[`plugin_name`]\n\n    const enableRefresh = process.env.ENABLE_GATSBY_REFRESH_ENDPOINT\n    const refreshToken = process.env.GATSBY_REFRESH_TOKEN\n    const authorizedRefresh =\n      !refreshToken || req.headers.authorization === refreshToken\n\n    if (enableRefresh && authorizedRefresh) {\n      refresh(req, pluginName)\n      res.status(200)\n      res.setHeader(`content-type`, `application/json`)\n    } else {\n      res.status(authorizedRefresh ? 404 : 403)\n      res.json({\n        error: enableRefresh\n          ? `Authorization failed. Make sure you add authorization header to your refresh requests`\n          : `Refresh endpoint is not enabled. Run gatsby with \"ENABLE_GATSBY_REFRESH_ENDPOINT=true\" environment variable set.`,\n        isEnabled: !!process.env.ENABLE_GATSBY_REFRESH_ENDPOINT,\n      })\n    }\n    res.end()\n  })\n\n  app.get(`/__open-stack-frame-in-editor`, (req, res) => {\n    if (req.query.fileName) {\n      const fileName = path.resolve(process.cwd(), req.query.fileName as string)\n      const lineNumber = parseInt(req.query.lineNumber as string, 10)\n      launchEditor(fileName, isNaN(lineNumber) ? 1 : lineNumber)\n    }\n    res.end()\n  })\n\n  addImageRoutes(app)\n\n  const webpackDevMiddlewareInstance = webpackDevMiddleware(compiler, {\n    publicPath: devConfig.output.publicPath,\n    stats: `errors-only`,\n    serverSideRender: true,\n  })\n\n  app.use(webpackDevMiddlewareInstance)\n\n  app.get(\n    `/page-data/:pagePath(*)/page-data.json`,\n    async (req, res, next): Promise<void> => {\n      const requestedPagePath = req.params.pagePath\n      if (!requestedPagePath) {\n        next()\n        return\n      }\n\n      const potentialPagePath = reverseFixedPagePath(requestedPagePath)\n      const page = findPageByPath(store.getState(), potentialPagePath, false)\n\n      if (page) {\n        try {\n          let serverDataPromise: Promise<IServerData> | Promise<Error> =\n            Promise.resolve({})\n          const pageMode = getPageMode(page)\n\n          if (pageMode === `SSR`) {\n            const renderer = require(PAGE_RENDERER_PATH)\n            const componentInstance = await renderer.getPageChunk(page)\n\n            serverDataPromise = getServerData(\n              req,\n              page,\n              potentialPagePath,\n              componentInstance\n            ).catch(error => error)\n          }\n\n          let pageData: IPageDataWithQueryResult\n          // TODO move to query-engine\n          if (process.env.GATSBY_EXPERIMENTAL_QUERY_ON_DEMAND) {\n            const start = Date.now()\n\n            pageData = await getPageDataExperimental(page.path)\n\n            telemetry.trackCli(`RUN_QUERY_ON_DEMAND`, {\n              name: `getPageData`,\n              duration: Date.now() - start,\n            })\n          } else {\n            pageData = await readPageData(\n              path.join(store.getState().program.directory, `public`),\n              page.path\n            )\n          }\n\n          let statusCode = 200\n          if (pageMode === `SSR`) {\n            try {\n              const result = await serverDataPromise\n\n              if (result instanceof Error) {\n                throw result\n              }\n\n              if (result.headers) {\n                for (const [name, value] of Object.entries(result.headers)) {\n                  res.setHeader(name, value)\n                }\n              }\n\n              if (result.status) {\n                statusCode = result.status\n              }\n\n              pageData.result.serverData = result.props\n              pageData.getServerDataError = null\n            } catch (error) {\n              const structuredError = report.panicOnBuild({\n                id: `95315`,\n                context: {\n                  sourceMessage: error.message,\n                  pagePath: requestedPagePath,\n                  potentialPagePath,\n                },\n                error,\n              })\n              // Use page-data.json file instead of emitting via websockets as this makes it easier\n              // to only display the relevant error + clearing of the error\n              // The query-result-store reacts to this\n              pageData.getServerDataError = structuredError\n            }\n            pageData.path = page.matchPath ? `/${potentialPagePath}` : page.path\n          } else {\n            // When user removes getServerData function, Gatsby browser runtime still has cached version of page-data.\n            // Send `null` to always reset cached serverData:\n            pageData.result.serverData = null\n          }\n\n          res.status(statusCode).send(pageData)\n          return\n        } catch (e) {\n          report.error(\n            `Error loading a result for the page query in \"${requestedPagePath}\" / \"${potentialPagePath}\". Query was not run and no cached result was found.`,\n            e\n          )\n        }\n      }\n\n      res.status(404).send({\n        path: potentialPagePath,\n      })\n    }\n  )\n\n  app.get(`/__original-stack-frame`, async (req, res) => {\n    const compilation = res.locals?.webpack?.devMiddleware?.stats?.compilation\n    const emptyResponse = {\n      codeFrame: `No codeFrame could be generated`,\n      sourcePosition: null,\n      sourceContent: null,\n    }\n\n    if (!compilation) {\n      res.json(emptyResponse)\n      return\n    }\n\n    const moduleId = req.query?.moduleId\n    const lineNumber = parseInt((req.query?.lineNumber as string) ?? 1, 10)\n    const columnNumber = parseInt((req.query?.columnNumber as string) ?? 1, 10)\n\n    let fileModule\n    for (const module of compilation.modules) {\n      const moduleIdentifier = compilation.chunkGraph.getModuleId(module)\n      if (moduleIdentifier === moduleId) {\n        fileModule = module\n        break\n      }\n    }\n\n    if (!fileModule) {\n      res.json(emptyResponse)\n      return\n    }\n\n    // We need the internal webpack file that is used in the bundle, not the module source.\n    // It doesn't have the correct sourceMap.\n    const webpackSource = compilation?.codeGenerationResults\n      ?.get(fileModule)\n      ?.sources.get(`javascript`)\n\n    const sourceMap = webpackSource?.map()\n\n    if (!sourceMap) {\n      res.json(emptyResponse)\n      return\n    }\n\n    const position = {\n      line: lineNumber,\n      column: columnNumber,\n    }\n    const result = await findOriginalSourcePositionAndContent(\n      sourceMap,\n      position\n    )\n\n    const sourcePosition = result?.sourcePosition\n    const sourceLine = sourcePosition?.line\n    const sourceColumn = sourcePosition?.column\n    const sourceContent = result?.sourceContent\n\n    if (!sourceContent || !sourceLine) {\n      res.json(emptyResponse)\n      return\n    }\n\n    const codeFrame = codeFrameColumns(\n      sourceContent,\n      {\n        start: {\n          line: sourceLine,\n          column: sourceColumn ?? 0,\n        },\n      },\n      {\n        highlightCode: true,\n      }\n    )\n    res.json({\n      codeFrame,\n      sourcePosition,\n      sourceContent,\n    })\n  })\n\n  app.get(`/__file-code-frame`, async (req, res) => {\n    const emptyResponse = {\n      codeFrame: `No codeFrame could be generated`,\n      sourcePosition: null,\n      sourceContent: null,\n    }\n\n    const filePath: string | undefined = req.query?.filePath as string\n    const lineNumber = parseInt(req.query?.lineNumber as string, 10)\n    const columnNumber = parseInt(req.query?.columnNumber as string, 10)\n\n    if (!filePath) {\n      res.json(emptyResponse)\n      return\n    }\n\n    const sourceContent = await fs.readFile(filePath, `utf-8`)\n\n    const codeFrame = codeFrameColumns(\n      sourceContent,\n      {\n        start: {\n          line: lineNumber,\n          column: columnNumber ?? 0,\n        },\n      },\n      {\n        highlightCode: true,\n      }\n    )\n    res.json({\n      codeFrame,\n    })\n  })\n\n  // Expose access to app for advanced use cases\n  const { developMiddleware } = store.getState().config\n\n  if (developMiddleware) {\n    developMiddleware(app, program)\n  }\n\n  const { proxy, trailingSlash } = store.getState().config\n\n  app.use(configureTrailingSlash(() => store.getState(), trailingSlash))\n\n  // Disable directory indexing i.e. serving index.html from a directory.\n  // This can lead to serving stale html files during development.\n  //\n  // We serve by default an empty index.html that sets up the dev environment.\n  app.use(developStatic(`public`, { index: false }))\n\n  // Set up API proxy.\n  if (proxy) {\n    proxy.forEach(({ prefix, url }) => {\n      app.use(`${prefix}/*`, (req, res) => {\n        const proxiedUrl = url + req.originalUrl\n        const {\n          // remove `host` from copied headers\n          // eslint-disable-next-line @typescript-eslint/no-unused-vars\n          headers: { host, ...headers },\n          method,\n        } = req\n        req\n          .pipe(\n            got\n              .stream(proxiedUrl, {\n                headers,\n                method: method as Method,\n                decompress: false,\n              })\n              .on(`response`, response =>\n                res.writeHead(response.statusCode || 200, response.headers)\n              )\n              .on(`error`, (err, _, response) => {\n                if (response) {\n                  res.writeHead(response.statusCode || 400, response.headers)\n                } else {\n                  const message = `Error when trying to proxy request \"${req.originalUrl}\" to \"${proxiedUrl}\"`\n\n                  report.error(message, err)\n                  res.sendStatus(500)\n                }\n              })\n          )\n          .pipe(res)\n      })\n    }, cors())\n  }\n\n  await apiRunnerNode(`onCreateDevServer`, { app, deferNodeMutation: true })\n\n  // In case nothing before handled hot-update - send 404.\n  // This fixes \"Unexpected token < in JSON at position 0\" runtime\n  // errors after restarting development server and\n  // cause automatic hard refresh in the browser.\n  app.use(/.*\\.hot-update\\.json$/i, (_, res) => {\n    res.status(404).end()\n  })\n\n  // Render an HTML page and serve it.\n  if (process.env.GATSBY_EXPERIMENTAL_DEV_SSR) {\n    app.get(`*`, async (req, res, next) => {\n      telemetry.trackFeatureIsUsed(`GATSBY_EXPERIMENTAL_DEV_SSR`)\n\n      const pathObj = findPageByPath(store.getState(), decodeURI(req.path))\n\n      if (!pathObj) {\n        return next()\n      }\n\n      await appendPreloadHeaders(pathObj.path, res)\n\n      const htmlActivity = report.phantomActivity(`building HTML for path`, {})\n      htmlActivity.start()\n\n      try {\n        const renderResponse = await renderDevHTML({\n          path: pathObj.path,\n          page: pathObj,\n          skipSsr: Object.prototype.hasOwnProperty.call(req.query, `skip-ssr`),\n          store,\n          htmlComponentRendererPath: PAGE_RENDERER_PATH,\n          directory: program.directory,\n        })\n        res.status(200).send(renderResponse)\n      } catch (error) {\n        // The page errored but couldn't read the page component.\n        // This is a race condition when a page is deleted but its requested\n        // immediately after before anything can recompile.\n        if (error === `404 page`) {\n          return next()\n        }\n\n        // renderDevHTML throws an error with these information\n        const lineNumber = error?.line as number\n        const columnNumber = error?.column as number\n        const filePath = error?.filename as string\n        const sourceContent = error?.sourceContent as string\n\n        report.error({\n          id: `11614`,\n          context: {\n            path: pathObj.path,\n            filePath: filePath,\n            line: lineNumber,\n            column: columnNumber,\n          },\n        })\n\n        const emptyResponse = {\n          codeFrame: `No codeFrame could be generated`,\n          sourcePosition: null,\n          sourceContent: null,\n        }\n\n        if (!sourceContent || !lineNumber) {\n          res.json(emptyResponse)\n          return null\n        }\n\n        const codeFrame = codeFrameColumns(\n          sourceContent,\n          {\n            start: {\n              line: lineNumber,\n              column: columnNumber ?? 0,\n            },\n          },\n          {\n            highlightCode: true,\n          }\n        )\n\n        const message = {\n          codeFrame,\n          source: filePath,\n          line: lineNumber,\n          column: columnNumber ?? 0,\n          sourceMessage: error?.message,\n          stack: error?.stack,\n        }\n\n        try {\n          // Generate a shell for client-only content -- for the error overlay\n          const clientOnlyShell = await renderDevHTML({\n            path: pathObj.path,\n            page: pathObj,\n            skipSsr: true,\n            store,\n            error: message,\n            htmlComponentRendererPath: PAGE_RENDERER_PATH,\n            directory: program.directory,\n          })\n\n          res.send(clientOnlyShell)\n        } catch (e) {\n          report.error({\n            id: `11616`,\n            context: {\n              sourceMessage: e.message,\n            },\n            filePath: e.filename,\n            location: {\n              start: {\n                line: e.line,\n                column: e.column,\n              },\n            },\n          })\n\n          const minimalHTML = `<head><title>Failed to Server Render (SSR)</title></head><body><h1>Failed to Server Render (SSR)</h1><h2>Error message:</h2><p>${e.message}</p><h2>File:</h2><p>${e.filename}:${e.line}:${e.column}</p><h2>Stack:</h2><pre><code>${e.stack}</code></pre></body>`\n\n          res.send(minimalHTML).status(500)\n        }\n      }\n\n      htmlActivity.end()\n\n      return null\n    })\n  }\n\n  if (\n    process.env.GATSBY_EXPERIMENTAL_QUERY_ON_DEMAND &&\n    process.env.GATSBY_QUERY_ON_DEMAND_LOADING_INDICATOR === `true`\n  ) {\n    routeLoadingIndicatorRequests(app)\n  }\n\n  app.use(async (req, res) => {\n    // in this catch-all block we don't support POST so we should 404\n    if (req.method === `POST`) {\n      res.status(404).end()\n      return\n    }\n\n    const fullUrl = req.protocol + `://` + req.get(`host`) + req.originalUrl\n    // This isn't used in development.\n    if (fullUrl.endsWith(`app-data.json`)) {\n      res.json({ webpackCompilationHash: `123` })\n      // If this gets here, it's a non-existent file so just send back 404.\n    } else if (fullUrl.endsWith(`.json`)) {\n      res.json({}).status(404)\n    } else {\n      await appendPreloadHeaders(req.path, res)\n\n      if (process.env.GATSBY_EXPERIMENTAL_DEV_SSR) {\n        try {\n          const { renderDevHTML } = require(`./dev-ssr/render-dev-html`)\n          const renderResponse = await renderDevHTML({\n            path: `/dev-404-page/`,\n            // Let renderDevHTML figure it out.\n            page: undefined,\n            store,\n            htmlComponentRendererPath: pageRenderer,\n            directory: program.directory,\n          })\n          res.status(404).send(renderResponse)\n        } catch (e) {\n          report.error({\n            id: `11615`,\n            context: {\n              sourceMessage: e.message,\n            },\n            filePath: e.filename,\n            location: {\n              start: {\n                line: e.line,\n                column: e.column,\n              },\n            },\n          })\n          res.send(e).status(500)\n        }\n      } else {\n        const potentialPagePath = reverseFixedPagePath(decodeURI(req.path))\n        const page = findPageByPath(store.getState(), potentialPagePath, false)\n\n        // When we can't find a page we send 404\n        if (!page) {\n          res.status(404)\n        }\n\n        res.sendFile(directoryPath(`.cache/develop-html/index.html`), err => {\n          if (err) {\n            res.status(500).end()\n          }\n        })\n      }\n    }\n  })\n\n  /**\n   * Set up the HTTP server and socket.io.\n   **/\n  const server = new http.Server(app)\n\n  const socket = websocketManager.init({ server })\n\n  // hardcoded `localhost`, because host should match `target` we set\n  // in http proxy in `develop-proxy`\n  const listener = server.listen(program.port, `localhost`)\n\n  if (!process.env.GATSBY_EXPERIMENTAL_DEV_SSR) {\n    const chokidar = require(`chokidar`)\n    // Register watcher that rebuilds index.html every time html.js changes.\n    const watchGlobs = [`src/html.js`, `plugins/**/gatsby-ssr.js`].map(path =>\n      slash(directoryPath(path))\n    )\n\n    chokidar.watch(watchGlobs).on(`change`, async () => {\n      await createIndexHtml(indexHTMLActivity)\n      // eslint-disable-next-line no-unused-expressions\n      socket?.to(`clients`).emit(`reload`)\n    })\n  }\n\n  return {\n    compiler,\n    listener,\n    webpackActivity,\n    websocketManager,\n    workerPool,\n    webpackWatching: webpackDevMiddlewareInstance.context.watching,\n  }\n}\n"],"file":"start-server.js"}