{"version":3,"sources":["../../../src/schema/types/sort.ts"],"names":["SORTABLE_ENUM","SORTABLE","NOT_SORTABLE","DEPRECATED_SORTABLE","getSortOrderEnum","schemaComposer","getOrCreateETC","etc","setFields","ASC","value","DESC","MAX_SORT_DEPTH","SORT_FIELD_DELIMITER","convert","typeComposer","fields","prefix","depth","deprecationReason","parentFieldDeprecationReason","sortFields","Object","keys","forEach","fieldName","fieldConfig","sortable","UnionTypeComposer","ScalarTypeComposer","undefined","getFieldExtension","sortKey","sortKeyFieldName","split","join","type","GraphQLList","GraphQLInputObjectType","getAnyTC","name","replace","assign","getFields","getFieldsEnum","inputTypeComposer","typeName","getTypeName","fieldsEnumTypeName","fieldsEnumTypeComposer","derivedTypeName","getType","getSortInput","fallbackType","sortOrderEnumTC","fieldsEnumTC","sortInputTypeName","getOrCreateITC","itc","addFields","order","defaultValue"],"mappings":"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","sourcesContent":["// @flow\nimport {\n  getNamedType,\n  getNullableType,\n  GraphQLInputObjectType,\n  GraphQLList,\n  GraphQLInputFieldMap,\n} from \"graphql\"\nimport { addDerivedType } from \"./derived-types\"\nimport {\n  SchemaComposer,\n  EnumTypeComposer,\n  ObjectTypeComposer,\n  InputTypeComposer,\n  InterfaceTypeComposer,\n  UnionTypeComposer,\n  ScalarTypeComposer,\n  toInputObjectType,\n} from \"graphql-compose\"\n\ntype AnyTypeComposer<TContext> =\n  | ObjectTypeComposer<any, TContext>\n  | InputTypeComposer<TContext>\n  | EnumTypeComposer<TContext>\n  | InterfaceTypeComposer<any, TContext>\n  | UnionTypeComposer<any, TContext>\n  | ScalarTypeComposer<TContext>\n\nexport const SORTABLE_ENUM = {\n  SORTABLE: `SORTABLE`,\n  NOT_SORTABLE: `NOT_SORTABLE`,\n  DEPRECATED_SORTABLE: `DEPRECATED_SORTABLE`,\n}\n\nexport const getSortOrderEnum = <TContext = any>({\n  schemaComposer,\n}: {\n  schemaComposer: SchemaComposer<TContext>\n}): EnumTypeComposer<TContext> =>\n  schemaComposer.getOrCreateETC(`SortOrderEnum`, etc => {\n    etc.setFields({\n      ASC: { value: `ASC` },\n      DESC: { value: `DESC` },\n    })\n  })\n\nconst MAX_SORT_DEPTH = 3\nconst SORT_FIELD_DELIMITER = `___`\n\nconst convert = <TContext = any>({\n  schemaComposer,\n  typeComposer,\n  fields,\n  prefix = null,\n  depth = 0,\n  deprecationReason: parentFieldDeprecationReason,\n}: {\n  schemaComposer: SchemaComposer<TContext>\n  typeComposer: AnyTypeComposer<TContext>\n  fields: GraphQLInputFieldMap\n  prefix?: string | null\n  depth?: number\n  deprecationReason?: string\n}): any => {\n  const sortFields = {}\n\n  Object.keys(fields).forEach(fieldName => {\n    let deprecationReason = parentFieldDeprecationReason\n    const fieldConfig = fields[fieldName]\n    const sortable =\n      typeComposer instanceof UnionTypeComposer ||\n      typeComposer instanceof ScalarTypeComposer\n        ? undefined\n        : typeComposer.getFieldExtension(fieldName, `sortable`)\n    if (sortable === SORTABLE_ENUM.NOT_SORTABLE) {\n      return\n    } else if (sortable === SORTABLE_ENUM.DEPRECATED_SORTABLE) {\n      deprecationReason = `Sorting on fields that need arguments to resolve is deprecated.`\n    }\n    const sortKey = prefix ? `${prefix}.${fieldName}` : fieldName\n    const sortKeyFieldName = sortKey.split(`.`).join(SORT_FIELD_DELIMITER)\n\n    // XXX(freiksenet): this is to preserve legacy behaviour, this probably doesn't actually sort\n    if (getNullableType(fieldConfig.type) instanceof GraphQLList) {\n      sortFields[sortKeyFieldName] = {\n        value: sortKey,\n        deprecationReason,\n      }\n    }\n\n    const type = getNamedType(fieldConfig.type)\n    if (type instanceof GraphQLInputObjectType) {\n      if (depth < MAX_SORT_DEPTH) {\n        const typeComposer = schemaComposer.getAnyTC(\n          type.name.replace(/Input$/, ``)\n        )\n        Object.assign(\n          sortFields,\n          convert({\n            schemaComposer,\n            typeComposer,\n            fields: type.getFields(),\n            prefix: sortKey,\n            depth: depth + 1,\n            deprecationReason,\n          })\n        )\n      }\n    } else {\n      // GraphQLScalarType || GraphQLEnumType\n      sortFields[sortKeyFieldName] = {\n        value: sortKey,\n        deprecationReason,\n      }\n    }\n  })\n  return sortFields\n}\n\nexport const getFieldsEnum = <TSource = any, TContext = any>({\n  schemaComposer,\n  typeComposer,\n  inputTypeComposer,\n}: {\n  schemaComposer: SchemaComposer<TContext>\n  typeComposer:\n    | ObjectTypeComposer<TSource, TContext>\n    | InterfaceTypeComposer<TSource, TContext>\n  inputTypeComposer: InputTypeComposer<TContext>\n}): EnumTypeComposer<TContext> => {\n  const typeName = typeComposer.getTypeName()\n  const fieldsEnumTypeName = `${typeName}FieldsEnum`\n  const fieldsEnumTypeComposer =\n    schemaComposer.getOrCreateETC(fieldsEnumTypeName)\n  addDerivedType({ typeComposer, derivedTypeName: fieldsEnumTypeName })\n\n  const fields = convert({\n    schemaComposer,\n    typeComposer,\n    fields: inputTypeComposer.getType().getFields(),\n  })\n  fieldsEnumTypeComposer.setFields(fields)\n  return fieldsEnumTypeComposer\n}\n\nexport const getSortInput = <TSource = any, TContext = any>({\n  schemaComposer,\n  typeComposer,\n}: {\n  schemaComposer: SchemaComposer<TContext>\n  typeComposer: ObjectTypeComposer<TSource, TContext>\n}): InputTypeComposer<TContext> => {\n  // toInputObjectType() will fail to convert fields of union types, e.g.\n  //   union FooBar = Foo | Bar\n  //   type Baz {\n  //     fooBar: FooBar\n  //   }\n  // Passing `fallbackType: null` allows us to skip this field in the input type\n  const inputTypeComposer = toInputObjectType(typeComposer, {\n    fallbackType: null,\n  })\n  const sortOrderEnumTC = getSortOrderEnum({ schemaComposer })\n  const fieldsEnumTC = getFieldsEnum({\n    schemaComposer,\n    typeComposer,\n    inputTypeComposer,\n  })\n  const typeName = typeComposer.getTypeName()\n  // console.log(fieldsEnumTC.getType().getValues())\n\n  const sortInputTypeName = `${typeName}SortInput`\n  addDerivedType({ typeComposer, derivedTypeName: sortInputTypeName })\n\n  return schemaComposer.getOrCreateITC(sortInputTypeName, itc => {\n    itc.addFields({\n      fields: [fieldsEnumTC],\n      order: { type: [sortOrderEnumTC], defaultValue: [`ASC`] },\n    })\n  })\n}\n"],"file":"sort.js"}