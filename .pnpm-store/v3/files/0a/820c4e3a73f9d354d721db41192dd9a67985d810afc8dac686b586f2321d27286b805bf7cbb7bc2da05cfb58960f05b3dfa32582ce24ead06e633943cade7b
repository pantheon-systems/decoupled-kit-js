{"version":3,"sources":["../../../src/steps/ingest-remote-schema/index.js"],"names":["ingestRemoteSchema","helpers","pluginOptions","process","env","NODE_ENV","schemaTimeKey","lastIngestRemoteSchemaTime","cache","get","ingestedSchemaInLastTenSeconds","Date","now","set","activity","reporter","activityTimer","start","checkIfSchemaHasChanged","introspectAndStoreRemoteSchema","identifyAndStoreIngestableFieldsAndTypes","buildNodeQueries","buildNonNodeQueries","cacheFetchedTypes","writeQueriesToDisk","e","panic","end"],"mappings":";;;;;AAAA;;AACA;;AAEA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAMA,kBAAkB,GAAG,OAAOC,OAAP,EAAgBC,aAAhB,KAAkC;AAC3D,MAAIC,OAAO,CAACC,GAAR,CAAYC,QAAZ,KAA0B,aAA9B,EAA4C;AAC1C;AACA;AACA;AACA;AACA;AACA,UAAMC,aAAa,GAAI,4BAAvB;AACA,UAAMC,0BAA0B,GAAG,MAAMN,OAAO,CAACO,KAAR,CAAcC,GAAd,CAAkBH,aAAlB,CAAzC;AAEA,UAAMI,8BAA8B,GAClCC,IAAI,CAACC,GAAL,KAAaL,0BAAb,IAA2C,KAD7C;;AAGA,QAAIA,0BAA0B,IAAIG,8BAAlC,EAAkE;AAChE;AACA;AACA;AACD;;AAED,UAAMT,OAAO,CAACO,KAAR,CAAcK,GAAd,CAAkBP,aAAlB,EAAiCK,IAAI,CAACC,GAAL,EAAjC,CAAN;AACD;;AAED,QAAME,QAAQ,GAAGb,OAAO,CAACc,QAAR,CAAiBC,aAAjB,CACf,wCAAkB,yBAAlB,CADe,CAAjB;AAIAF,EAAAA,QAAQ,CAACG,KAAT;;AAEA,MAAI;AACF,UAAM,wBACJ,CACEC,oCADF,EAEEC,sDAFF,EAGEC,yEAHF,EAIE,CAACC,kCAAD,EAAmBC,mEAAnB,CAJF,EAKE,CAACC,oCAAD,EAAoBC,sCAApB,CALF,CADI,EAQJvB,OARI,EASJC,aATI,CAAN;AAWD,GAZD,CAYE,OAAOuB,CAAP,EAAU;AACVX,IAAAA,QAAQ,CAACY,KAAT,CAAeD,CAAf;AACD,GAdD,SAcU;AACRX,IAAAA,QAAQ,CAACa,GAAT;AACD;AACF,CA7CD","sourcesContent":["import { runSteps } from \"~/utils/run-steps\"\nimport { formatLogMessage } from \"~/utils/format-log-message\"\n\nimport { checkIfSchemaHasChanged } from \"./diff-schemas\"\nimport { introspectAndStoreRemoteSchema } from \"./introspect-remote-schema\"\nimport { identifyAndStoreIngestableFieldsAndTypes } from \"./identify-and-store-ingestable-types\"\nimport { buildNonNodeQueries } from \"./build-and-store-ingestible-root-field-non-node-queries\"\nimport { buildNodeQueries } from \"./build-queries-from-introspection/build-node-queries\"\nimport { cacheFetchedTypes } from \"./cache-fetched-types\"\nimport { writeQueriesToDisk } from \"./write-queries-to-disk\"\n\n/**\n * This fn is called during schema customization.\n * It pulls in the remote WPGraphQL schema, caches it,\n * then builds queries and stores a transformed object\n * later used in schema customization.\n *\n * This fn must run in all PQR workers.\n */\nconst ingestRemoteSchema = async (helpers, pluginOptions) => {\n  if (process.env.NODE_ENV === `development`) {\n    // running this code block in production is problematic for PQR\n    // since this fn will run once for each worker and we need the result in each\n    // we'll return early in most workers when it checks the cache here\n    // Since PQR doesn't run in development and this code block was only meant for dev\n    // it should be ok to wrap it in this if statement\n    const schemaTimeKey = `lastIngestRemoteSchemaTime`\n    const lastIngestRemoteSchemaTime = await helpers.cache.get(schemaTimeKey)\n\n    const ingestedSchemaInLastTenSeconds =\n      Date.now() - lastIngestRemoteSchemaTime <= 10000\n\n    if (lastIngestRemoteSchemaTime && ingestedSchemaInLastTenSeconds) {\n      // only allow this to run once every ten seconds\n      // this prevents thrashing when many webhooks are received at once\n      return\n    }\n\n    await helpers.cache.set(schemaTimeKey, Date.now())\n  }\n\n  const activity = helpers.reporter.activityTimer(\n    formatLogMessage(`ingest WPGraphQL schema`)\n  )\n\n  activity.start()\n\n  try {\n    await runSteps(\n      [\n        checkIfSchemaHasChanged,\n        introspectAndStoreRemoteSchema,\n        identifyAndStoreIngestableFieldsAndTypes,\n        [buildNodeQueries, buildNonNodeQueries],\n        [cacheFetchedTypes, writeQueriesToDisk],\n      ],\n      helpers,\n      pluginOptions\n    )\n  } catch (e) {\n    activity.panic(e)\n  } finally {\n    activity.end()\n  }\n}\n\nexport { ingestRemoteSchema }\n"],"file":"index.js"}