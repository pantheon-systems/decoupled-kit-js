{"version":3,"sources":["../../src/query/query-runner.ts"],"names":["resultHashCache","getResultHashCache","GatsbyCacheLmdb","name","encoding","init","reportLongRunningQueryJob","queryJob","messageParts","componentPath","isPage","path","context","push","_","isEmpty","JSON","stringify","report","warn","join","panicQueryJobError","errors","urlPath","undefined","queryContext","plugin","pluginCreatorId","structuredErrors","map","e","structuredError","message","filePath","location","error","codeFrame","query","locations","line","column","panicOnBuild","startQueryJob","graphqlRunner","parentSpan","isPending","timeoutId","setTimeout","queryName","id","finally","clearTimeout","queryRunner","program","store","getState","dispatch","actions","queryStart","result","Object","assign","pageContext","internalComponentName","component","componentChunkName","updatedAt","pluginCreator___NODE","isCreatedByStatefulCreatePages","matchPath","mode","resultJSON","resultHash","crypto","createHash","update","digest","get","directory","set","type","payload","resultPath","hash","fs","outputFile","pageQueryRun","queryHash"],"mappings":";;;;;;;AACA;;AACA;;AACA;;AACA;;AAGA;;AACA;;AACA;;AACA;;AACA;;AAIA;;AACA;;AAEA,IAAIA,eAAJ;;AACA,SAASC,kBAAT,GAA+C;AAC7C,MAAI,CAACD,eAAL,EAAsB;AACpBA,IAAAA,eAAe,GAAG,IAAIE,kBAAJ,CAAoB;AACpCC,MAAAA,IAAI,EAAG,qBAD6B;AAEpCC,MAAAA,QAAQ,EAAG;AAFyB,KAApB,EAGfC,IAHe,EAAlB;AAID;;AACD,SAAOL,eAAP;AACD;;AAYD,SAASM,yBAAT,CAAmCC,QAAnC,EAAmD;AACjD,QAAMC,YAAY,GAAG,CAClB,2IADkB,EAElB,cAAaD,QAAQ,CAACE,aAAc,EAFlB,CAArB;;AAKA,MAAIF,QAAQ,CAACG,MAAb,EAAqB;AACnB,UAAM;AAAEC,MAAAA,IAAF;AAAQC,MAAAA;AAAR,QAAoBL,QAAQ,CAACK,OAAnC;AACAJ,IAAAA,YAAY,CAACK,IAAb,CAAmB,aAAYF,IAAK,EAApC;;AAEA,QAAI,CAACG,gBAAEC,OAAF,CAAUH,OAAV,CAAL,EAAyB;AACvBJ,MAAAA,YAAY,CAACK,IAAb,CAAmB,YAAWG,IAAI,CAACC,SAAL,CAAeL,OAAf,EAAwB,IAAxB,EAA8B,CAA9B,CAAiC,EAA/D;AACD;AACF;;AAEDM,oBAAOC,IAAP,CAAYX,YAAY,CAACY,IAAb,CAAmB,IAAnB,CAAZ;AACD;;AAED,SAASC,kBAAT,CACEd,QADF,EAEEe,MAFF,EAGQ;AACN,MAAIC,OAAO,GAAGC,SAAd;AACA,MAAIC,YAAY,GAAG,EAAnB;AACA,QAAMC,MAAM,GAAGnB,QAAQ,CAACoB,eAAT,IAA6B,MAA5C;;AAEA,MAAIpB,QAAQ,CAACG,MAAb,EAAqB;AACnBa,IAAAA,OAAO,GAAGhB,QAAQ,CAACK,OAAT,CAAiBD,IAA3B;AACAc,IAAAA,YAAY,GAAGlB,QAAQ,CAACK,OAAT,CAAiBA,OAAhC;AACD;;AAED,QAAMgB,gBAAgB,GAAGN,MAAM,CAACO,GAAP,CAAWC,CAAC,IAAI;AACvC,UAAMC,eAAe,GAAG,0BAAY;AAClCC,MAAAA,OAAO,EAAEF,CAAC,CAACE,OADuB;AAElCC,MAAAA,QAAQ,EAAET,SAFwB;AAGlCU,MAAAA,QAAQ,EAAEV,SAHwB;AAIlCW,MAAAA,KAAK,EAAEL;AAJ2B,KAAZ,CAAxB;AAOAC,IAAAA,eAAe,CAACnB,OAAhB,GAA0B,EACxB,GAAGmB,eAAe,CAACnB,OADK;AAExBwB,MAAAA,SAAS,EAAE,0CACT7B,QAAQ,CAAC8B,KADA,EAETP,CAAC,CAACQ,SAAF,IAAeR,CAAC,CAACQ,SAAF,CAAY,CAAZ,EAAeC,IAFrB,EAGTT,CAAC,CAACQ,SAAF,IAAeR,CAAC,CAACQ,SAAF,CAAY,CAAZ,EAAeE,MAHrB,CAFa;AAOxBP,MAAAA,QAAQ,EAAE1B,QAAQ,CAACE,aAPK;AAQxB,UAAIc,OAAO,GAAG;AAAEA,QAAAA;AAAF,OAAH,GAAiB,EAA5B,CARwB;AASxB,SAAGE,YATqB;AAUxBC,MAAAA;AAVwB,KAA1B;AAaA,WAAOK,eAAP;AACD,GAtBwB,CAAzB;;AAwBAb,oBAAOuB,YAAP,CAAoBb,gBAApB;AACD;;AAED,eAAec,aAAf,CACEC,aADF,EAEEpC,QAFF,EAGEqC,UAHF,EAI4B;AAC1B,MAAIC,SAAS,GAAG,IAAhB,CAD0B,CAG1B;;AACA,QAAMC,SAAS,GAAGC,UAAU,CAAC,MAAM;AACjC,QAAIF,SAAJ,EAAe;AACbvC,MAAAA,yBAAyB,CAACC,QAAD,CAAzB;AACD;AACF,GAJ2B,EAIzB,KAJyB,CAA5B;AAMA,SAAOoC,aAAa,CACjBN,KADI,CACE9B,QAAQ,CAAC8B,KADX,EACkB9B,QAAQ,CAACK,OAD3B,EACoC;AACvCgC,IAAAA,UADuC;AAEvCI,IAAAA,SAAS,EAAEzC,QAAQ,CAAC0C,EAFmB;AAGvCxC,IAAAA,aAAa,EAAEF,QAAQ,CAACE;AAHe,GADpC,EAMJyC,OANI,CAMI,MAAM;AACbL,IAAAA,SAAS,GAAG,KAAZ;AACAM,IAAAA,YAAY,CAACL,SAAD,CAAZ;AACD,GATI,CAAP;AAUD;;AAEM,eAAeM,WAAf,CACLT,aADK,EAELpC,QAFK,EAGLqC,UAHK,EAIsB;AAC3B,QAAM;AAAES,IAAAA;AAAF,MAAcC,aAAMC,QAAN,EAApB;;AAEAD,eAAME,QAAN,CACEC,iBAAQC,UAAR,CAAmB;AACjB/C,IAAAA,IAAI,EAAEJ,QAAQ,CAAC0C,EADE;AAEjBxC,IAAAA,aAAa,EAAEF,QAAQ,CAACE,aAFP;AAGjBC,IAAAA,MAAM,EAAEH,QAAQ,CAACG;AAHA,GAAnB,CADF,EAH2B,CAW3B;;;AACA,MAAIiD,MAAJ,CAZ2B,CAa3B;;AACA,MAAI,CAACpD,QAAQ,CAAC8B,KAAV,IAAmB9B,QAAQ,CAAC8B,KAAT,KAAoB,EAA3C,EAA8C;AAC5CsB,IAAAA,MAAM,GAAG,EAAT;AACD,GAFD,MAEO;AACLA,IAAAA,MAAM,GAAG,MAAMjB,aAAa,CAACC,aAAD,EAAgBpC,QAAhB,EAA0BqC,UAA1B,CAA5B;AACD;;AAED,MAAIe,MAAM,CAACrC,MAAX,EAAmB;AACjB;AACAD,IAAAA,kBAAkB,CAACd,QAAD,EAAWoD,MAAM,CAACrC,MAAlB,CAAlB;AACD,GAvB0B,CAyB3B;;;AACA,MAAIf,QAAQ,IAAIA,QAAQ,CAACG,MAAzB,EAAiC;AAC/BiD,IAAAA,MAAM,CAAE,aAAF,CAAN,GAAwBC,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkBtD,QAAQ,CAACK,OAA3B,CAAxB;AACD,GA5B0B,CA8B3B;;;AACA,MAAI+C,MAAM,CAACG,WAAX,EAAwB;AACtB,WAAOH,MAAM,CAACG,WAAP,CAAmBnD,IAA1B;AACA,WAAOgD,MAAM,CAACG,WAAP,CAAmBC,qBAA1B;AACA,WAAOJ,MAAM,CAACG,WAAP,CAAmBE,SAA1B;AACA,WAAOL,MAAM,CAACG,WAAP,CAAmBG,kBAA1B;AACA,WAAON,MAAM,CAACG,WAAP,CAAmBI,SAA1B;AACA,WAAOP,MAAM,CAACG,WAAP,CAAmBK,oBAA1B;AACA,WAAOR,MAAM,CAACG,WAAP,CAAmBnC,eAA1B;AACA,WAAOgC,MAAM,CAACG,WAAP,CAAmBrD,aAA1B;AACA,WAAOkD,MAAM,CAACG,WAAP,CAAmBlD,OAA1B;AACA,WAAO+C,MAAM,CAACG,WAAP,CAAmBM,8BAA1B;;AAEA,QAAI,QAA2B,GAA/B,EAAmC;AACjC;AACA,aAAOT,MAAM,CAACG,WAAP,CAAmBO,SAA1B;AACA,aAAOV,MAAM,CAACG,WAAP,CAAmBQ,IAA1B;AACD;AACF;;AAED,QAAMC,UAAU,GAAGvD,IAAI,CAACC,SAAL,CAAe0C,MAAf,CAAnB;;AACA,QAAMa,UAAU,GAAGC,gBAChBC,UADgB,CACJ,MADI,EAEhBC,MAFgB,CAETJ,UAFS,EAGhBK,MAHgB,CAGR,QAHQ,CAAnB;;AAKA,QAAM5E,eAAe,GAAGC,kBAAkB,EAA1C;;AACA,MACEuE,UAAU,MAAM,MAAMxE,eAAe,CAAC6E,GAAhB,CAAoBtE,QAAQ,CAAC0C,EAA7B,CAAZ,CAAV,IACC1C,QAAQ,CAACG,MAAT,IACC,CAAC,8BAAeC,cAAKS,IAAL,CAAUiC,OAAO,CAACyB,SAAlB,EAA8B,QAA9B,CAAf,EAAuDvE,QAAQ,CAAC0C,EAAhE,CAHL,EAIE;AACA,UAAMjD,eAAe,CAAC+E,GAAhB,CAAoBxE,QAAQ,CAAC0C,EAA7B,EAAiCuB,UAAjC,CAAN;;AAEA,QAAIjE,QAAQ,CAACG,MAAb,EAAqB;AACnB;AACA;AACA,YAAM,mCAAoB2C,OAAO,CAACyB,SAA5B,EAAuCvE,QAAQ,CAAC0C,EAAhD,EAAoDsB,UAApD,CAAN;;AACAjB,mBAAME,QAAN,CAAe;AACbwB,QAAAA,IAAI,EAAG,6BADM;AAEbC,QAAAA,OAAO,EAAE;AACPtE,UAAAA,IAAI,EAAEJ,QAAQ,CAAC0C;AADR;AAFI,OAAf;AAMD,KAVD,MAUO;AACL,YAAMiC,UAAU,GAAGvE,cAAKS,IAAL,CACjBiC,OAAO,CAACyB,SADS,EAEhB,QAFgB,EAGhB,WAHgB,EAIhB,IAJgB,EAKhB,GALgB,EAMhB,GAAEvE,QAAQ,CAAC4E,IAAK,OANA,CAAnB;;AAQA,YAAMC,iBAAGC,UAAH,CAAcH,UAAd,EAA0BX,UAA1B,CAAN;AACD;AACF,GArF0B,CAuF3B;;;AACAjB,eAAME,QAAN,CACEC,iBAAQ6B,YAAR,CAAqB;AACnB3E,IAAAA,IAAI,EAAEJ,QAAQ,CAAC0C,EADI;AAEnBxC,IAAAA,aAAa,EAAEF,QAAQ,CAACE,aAFL;AAGnBC,IAAAA,MAAM,EAAEH,QAAQ,CAACG,MAHE;AAInB8D,IAAAA,UAJmB;AAKnBe,IAAAA,SAAS,EAAEhF,QAAQ,CAAC4E;AALD,GAArB,CADF;;AAUA,SAAOxB,MAAP;AACD","sourcesContent":["import { Span } from \"opentracing\"\nimport _ from \"lodash\"\nimport fs from \"fs-extra\"\nimport report from \"gatsby-cli/lib/reporter\"\nimport crypto from \"crypto\"\nimport { ExecutionResult, GraphQLError } from \"graphql\"\n\nimport path from \"path\"\nimport { store } from \"../redux\"\nimport { actions } from \"../redux/actions\"\nimport { getCodeFrame } from \"./graphql-errors-codeframe\"\nimport errorParser from \"./error-parser\"\n\nimport { GraphQLRunner } from \"./graphql-runner\"\nimport { IExecutionResult, PageContext } from \"./types\"\nimport { pageDataExists, savePageQueryResult } from \"../utils/page-data\"\nimport GatsbyCacheLmdb from \"../utils/cache-lmdb\"\n\nlet resultHashCache: GatsbyCacheLmdb | undefined\nfunction getResultHashCache(): GatsbyCacheLmdb {\n  if (!resultHashCache) {\n    resultHashCache = new GatsbyCacheLmdb({\n      name: `query-result-hashes`,\n      encoding: `string`,\n    }).init()\n  }\n  return resultHashCache\n}\n\nexport interface IQueryJob {\n  id: string\n  hash?: string\n  query: string\n  componentPath: string\n  context: PageContext\n  isPage: boolean\n  pluginCreatorId?: string\n}\n\nfunction reportLongRunningQueryJob(queryJob): void {\n  const messageParts = [\n    `This query took more than 15s to run â€” which is unusually long and might indicate you're querying too much or have some unoptimized code:`,\n    `File path: ${queryJob.componentPath}`,\n  ]\n\n  if (queryJob.isPage) {\n    const { path, context } = queryJob.context\n    messageParts.push(`URL path: ${path}`)\n\n    if (!_.isEmpty(context)) {\n      messageParts.push(`Context: ${JSON.stringify(context, null, 4)}`)\n    }\n  }\n\n  report.warn(messageParts.join(`\\n`))\n}\n\nfunction panicQueryJobError(\n  queryJob: IQueryJob,\n  errors: ReadonlyArray<GraphQLError>\n): void {\n  let urlPath = undefined\n  let queryContext = {}\n  const plugin = queryJob.pluginCreatorId || `none`\n\n  if (queryJob.isPage) {\n    urlPath = queryJob.context.path\n    queryContext = queryJob.context.context\n  }\n\n  const structuredErrors = errors.map(e => {\n    const structuredError = errorParser({\n      message: e.message,\n      filePath: undefined,\n      location: undefined,\n      error: e,\n    })\n\n    structuredError.context = {\n      ...structuredError.context,\n      codeFrame: getCodeFrame(\n        queryJob.query,\n        e.locations && e.locations[0].line,\n        e.locations && e.locations[0].column\n      ),\n      filePath: queryJob.componentPath,\n      ...(urlPath ? { urlPath } : {}),\n      ...queryContext,\n      plugin,\n    }\n\n    return structuredError\n  })\n\n  report.panicOnBuild(structuredErrors)\n}\n\nasync function startQueryJob(\n  graphqlRunner: GraphQLRunner,\n  queryJob: IQueryJob,\n  parentSpan: Span | undefined\n): Promise<ExecutionResult> {\n  let isPending = true\n\n  // Print out warning when query takes too long\n  const timeoutId = setTimeout(() => {\n    if (isPending) {\n      reportLongRunningQueryJob(queryJob)\n    }\n  }, 15000)\n\n  return graphqlRunner\n    .query(queryJob.query, queryJob.context, {\n      parentSpan,\n      queryName: queryJob.id,\n      componentPath: queryJob.componentPath,\n    })\n    .finally(() => {\n      isPending = false\n      clearTimeout(timeoutId)\n    })\n}\n\nexport async function queryRunner(\n  graphqlRunner: GraphQLRunner,\n  queryJob: IQueryJob,\n  parentSpan: Span | undefined\n): Promise<IExecutionResult> {\n  const { program } = store.getState()\n\n  store.dispatch(\n    actions.queryStart({\n      path: queryJob.id,\n      componentPath: queryJob.componentPath,\n      isPage: queryJob.isPage,\n    })\n  )\n\n  // Run query\n  let result: IExecutionResult\n  // Nothing to do if the query doesn't exist.\n  if (!queryJob.query || queryJob.query === ``) {\n    result = {}\n  } else {\n    result = await startQueryJob(graphqlRunner, queryJob, parentSpan)\n  }\n\n  if (result.errors) {\n    // If there's a graphql error then log the error and exit\n    panicQueryJobError(queryJob, result.errors)\n  }\n\n  // Add the page context onto the results.\n  if (queryJob && queryJob.isPage) {\n    result[`pageContext`] = Object.assign({}, queryJob.context)\n  }\n\n  // Delete internal data from pageContext\n  if (result.pageContext) {\n    delete result.pageContext.path\n    delete result.pageContext.internalComponentName\n    delete result.pageContext.component\n    delete result.pageContext.componentChunkName\n    delete result.pageContext.updatedAt\n    delete result.pageContext.pluginCreator___NODE\n    delete result.pageContext.pluginCreatorId\n    delete result.pageContext.componentPath\n    delete result.pageContext.context\n    delete result.pageContext.isCreatedByStatefulCreatePages\n\n    if (_CFLAGS_.GATSBY_MAJOR === `4`) {\n      // we shouldn't add matchPath to pageContext but technically this is a breaking change so moving it ot v4\n      delete result.pageContext.matchPath\n      delete result.pageContext.mode\n    }\n  }\n\n  const resultJSON = JSON.stringify(result)\n  const resultHash = crypto\n    .createHash(`sha1`)\n    .update(resultJSON)\n    .digest(`base64`)\n\n  const resultHashCache = getResultHashCache()\n  if (\n    resultHash !== (await resultHashCache.get(queryJob.id)) ||\n    (queryJob.isPage &&\n      !pageDataExists(path.join(program.directory, `public`), queryJob.id))\n  ) {\n    await resultHashCache.set(queryJob.id, resultHash)\n\n    if (queryJob.isPage) {\n      // We need to save this temporarily in cache because\n      // this might be incomplete at the moment\n      await savePageQueryResult(program.directory, queryJob.id, resultJSON)\n      store.dispatch({\n        type: `ADD_PENDING_PAGE_DATA_WRITE`,\n        payload: {\n          path: queryJob.id,\n        },\n      })\n    } else {\n      const resultPath = path.join(\n        program.directory,\n        `public`,\n        `page-data`,\n        `sq`,\n        `d`,\n        `${queryJob.hash}.json`\n      )\n      await fs.outputFile(resultPath, resultJSON)\n    }\n  }\n\n  // Broadcast that a page's query has run.\n  store.dispatch(\n    actions.pageQueryRun({\n      path: queryJob.id,\n      componentPath: queryJob.componentPath,\n      isPage: queryJob.isPage,\n      resultHash,\n      queryHash: queryJob.hash,\n    })\n  )\n\n  return result\n}\n"],"file":"query-runner.js"}