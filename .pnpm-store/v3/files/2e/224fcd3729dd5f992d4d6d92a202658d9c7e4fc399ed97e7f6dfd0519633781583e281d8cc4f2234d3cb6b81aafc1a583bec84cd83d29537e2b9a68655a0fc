{"version":3,"sources":["../../../../src/steps/source-nodes/fetch-nodes/fetch-nodes-paginated.js"],"names":["normalizeNode","node","nodeTypeName","normalizedNodeTypeName","__typename","type","nodeType","idSet","Set","hasLoggedDuplicateMessage","paginatedWpNodeFetch","contentTypePlural","query","helpers","throwFetchErrors","throwGqlErrors","allContentNodes","after","settings","headers","variables","limit","length","first","errorContext","response","data","nodes","pageInfo","hasNextPage","endCursor","filter","Boolean","forEach","existingId","has","id","existingNode","find","innerNode","reporter","warn","databaseId","uri","info","add","push","store","dispatch","logger","incrementActivityTimer","typeName","by"],"mappings":"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","sourcesContent":["import fetchGraphql from \"~/utils/fetch-graphql\"\nimport store from \"~/store\"\nimport { formatLogMessage } from \"../../../utils/format-log-message\"\n\nexport const normalizeNode = ({ node, nodeTypeName }) => {\n  const normalizedNodeTypeName = node.__typename || nodeTypeName\n  // @todo is node.type used anywhere??\n  node.type = normalizedNodeTypeName\n  // this is used to filter node interfaces by content types\n  node.nodeType = normalizedNodeTypeName\n\n  return node\n}\n\n// this is used to determine wether we've already seen an id\n// for cold builds.\n// the reason we want to do this is to detect if we create 2 nodes with the same id\n// if we do there will be less nodes in Gatsby than in WP and users will be confused.\nconst idSet = new Set()\nlet hasLoggedDuplicateMessage = false\n\n/**\n * paginatedWpNodeFetch\n *\n * recursively fetches/paginates remote nodes\n */\nconst paginatedWpNodeFetch = async ({\n  contentTypePlural,\n  query,\n  nodeTypeName,\n  helpers,\n  throwFetchErrors = false,\n  throwGqlErrors = false,\n  allContentNodes = [],\n  after = null,\n  settings = {},\n  headers = {},\n  ...variables\n}) => {\n  if (\n    !settings.limit &&\n    typeof settings.limit === `number` &&\n    settings.limit === 0\n  ) {\n    // if the Type.limit plugin option is set to the number 0,\n    // we shouldn't fetch anything\n    return []\n  }\n\n  if (\n    settings.limit &&\n    // if we're about to fetch more than our limit\n    allContentNodes.length + variables.first > settings.limit\n  ) {\n    // just fetch whatever number is remaining\n    variables.first = settings.limit - allContentNodes.length\n  }\n\n  // if the GQL var \"first\" is greater than our Type.limit plugin option,\n  // that's no good\n  if (settings.limit && settings.limit < variables.first) {\n    // so just fetch our limit\n    variables.first = settings.limit\n  }\n\n  const errorContext = `Error occurred while fetching nodes of the \"${nodeTypeName}\" type.`\n\n  const response = await fetchGraphql({\n    query,\n    throwFetchErrors,\n    throwGqlErrors,\n    variables: {\n      ...variables,\n      after,\n    },\n    errorContext,\n    headers,\n  })\n\n  const { data } = response\n\n  if (!data?.[contentTypePlural]?.nodes) {\n    return allContentNodes\n  }\n\n  let {\n    [contentTypePlural]: { nodes, pageInfo },\n  } = data\n\n  const { hasNextPage, endCursor } = pageInfo || {}\n\n  // Sometimes private posts return as null.\n  // That causes problems for us so let's strip them out\n  nodes = nodes.filter(Boolean)\n\n  if (nodes && nodes.length) {\n    nodes.forEach(node => {\n      const existingId = idSet.has(node.id)\n\n      if (\n        existingId &&\n        // when the since variable is present\n        // we're fetching lists of node updates from WPGQL\n        // in that case we don't need to worry about logging duplicates\n        !(`since` in variables)\n      ) {\n        const existingNode = allContentNodes.find(\n          innerNode => innerNode.id === node.id\n        )\n\n        if (existingNode) {\n          if (!hasLoggedDuplicateMessage) {\n            hasLoggedDuplicateMessage = true\n            helpers.reporter.warn(\n              formatLogMessage(\n                `Found a duplicate ID in WordPress - this means you will have fewer nodes in Gatsby than in WordPress. This will need to be resolved in WP by identifying and fixing the underlying bug with your WP plugins or custom code.`\n              )\n            )\n          }\n\n          if (node?.databaseId && node?.uri && existingNode?.uri) {\n            helpers.reporter.info(\n              formatLogMessage(\n                `#${node.databaseId} (${node.uri}) is a duplicate of ${existingNode.databaseId} (${existingNode.uri})`\n              )\n            )\n          }\n        }\n      } else {\n        idSet.add(node.id)\n      }\n\n      node = normalizeNode({ node, nodeTypeName })\n      allContentNodes.push(node)\n    })\n\n    // MediaItem type is incremented in createMediaItemNode\n    if (nodeTypeName !== `MediaItem`) {\n      store.dispatch.logger.incrementActivityTimer({\n        typeName: nodeTypeName,\n        by: nodes.length,\n      })\n    }\n  }\n\n  if (\n    hasNextPage &&\n    endCursor &&\n    (!settings.limit || settings.limit > allContentNodes.length)\n  ) {\n    return paginatedWpNodeFetch({\n      ...variables,\n      contentTypePlural,\n      nodeTypeName,\n      query,\n      allContentNodes,\n      helpers,\n      settings,\n      after: endCursor,\n      headers,\n    })\n  } else {\n    return allContentNodes\n  }\n}\n\nexport { paginatedWpNodeFetch }\n"],"file":"fetch-nodes-paginated.js"}