{"version":3,"sources":["../../src/utils/cache.ts"],"names":["MAX_CACHE_SIZE","TTL","Number","MAX_SAFE_INTEGER","GatsbyCache","constructor","name","store","fsStore","directory","path","join","process","cwd","init","fs","ensureDirSync","configs","max","ttl","options","caches","map","cache","manager","caching","multiCaching","get","key","Promise","resolve","Error","err","res","undefined","set","value","args","del"],"mappings":";;;;;;;AAAA;;AAMA;;AACA;;AACA;;;;;;AAEA,MAAMA,cAAc,GAAG,GAAvB;AACA,MAAMC,GAAG,GAAGC,MAAM,CAACC,gBAAnB;;AAOe,MAAMC,WAAN,CAAkB;AAI/B;AACA;AACA;AAGA;AACAC,EAAAA,WAAW,CAAC;AAAEC,IAAAA,IAAI,GAAI,IAAV;AAAeC,IAAAA,KAAK,GAAGC;AAAvB,MAAqD,EAAtD,EAA0D;AACnE,SAAKF,IAAL,GAAYA,IAAZ;AACA,SAAKC,KAAL,GAAaA,KAAb;AACA,SAAKE,SAAL,GAAiBC,cAAKC,IAAL,CAAUC,OAAO,CAACC,GAAR,EAAV,EAA0B,iBAAgBP,IAAK,EAA/C,CAAjB;AACD;;AAEDQ,EAAAA,IAAI,GAAgB;AAClBC,qBAAGC,aAAH,CAAiB,KAAKP,SAAtB;;AAEA,UAAMQ,OAA2B,GAAG,CAClC;AACEV,MAAAA,KAAK,EAAG,QADV;AAEEW,MAAAA,GAAG,EAAElB,cAFP;AAGEmB,MAAAA,GAAG,EAAElB;AAHP,KADkC,EAMlC;AACEM,MAAAA,KAAK,EAAE,KAAKA,KADd;AAEEY,MAAAA,GAAG,EAAElB,GAFP;AAGEmB,MAAAA,OAAO,EAAE;AACPV,QAAAA,IAAI,EAAE,KAAKD,SADJ;AAEPU,QAAAA,GAAG,EAAElB;AAFE;AAHX,KANkC,CAApC;AAgBA,UAAMoB,MAAM,GAAGJ,OAAO,CAACK,GAAR,CAAYC,KAAK,IAAIC,sBAAQC,OAAR,CAAgBF,KAAhB,CAArB,CAAf;AAEA,SAAKA,KAAL,GAAaC,sBAAQE,YAAR,CAAqBL,MAArB,CAAb;AAEA,WAAO,IAAP;AACD;;AAEQ,QAAHM,GAAG,CAAcC,GAAd,EAA2C;AAClD,WAAO,IAAIC,OAAJ,CAAYC,OAAO,IAAI;AAC5B,UAAI,CAAC,KAAKP,KAAV,EAAiB;AACf,cAAM,IAAIQ,KAAJ,CACH,sEADG,CAAN;AAGD;;AACD,WAAKR,KAAL,CAAWI,GAAX,CAAkBC,GAAlB,EAAuB,CAACI,GAAD,EAAMC,GAAN,KAAc;AACnCH,QAAAA,OAAO,CAACE,GAAG,GAAGE,SAAH,GAAeD,GAAnB,CAAP;AACD,OAFD;AAGD,KATM,CAAP;AAUD;;AAEQ,QAAHE,GAAG,CACPP,GADO,EAEPQ,KAFO,EAGPC,IAAmB,GAAG;AAAElB,IAAAA,GAAG,EAAElB;AAAP,GAHf,EAIiB;AACxB,WAAO,IAAI4B,OAAJ,CAAYC,OAAO,IAAI;AAC5B,UAAI,CAAC,KAAKP,KAAV,EAAiB;AACf,cAAM,IAAIQ,KAAJ,CACH,sEADG,CAAN;AAGD;;AACD,WAAKR,KAAL,CAAWY,GAAX,CAAeP,GAAf,EAAoBQ,KAApB,EAA2BC,IAA3B,EAAiCL,GAAG,IAAI;AACtCF,QAAAA,OAAO,CAACE,GAAG,GAAGE,SAAH,GAAeE,KAAnB,CAAP;AACD,OAFD;AAGD,KATM,CAAP;AAUD;;AAEQ,QAAHE,GAAG,CAACV,GAAD,EAA6B;AACpC,QAAI,CAAC,KAAKL,KAAV,EAAiB;AACf,YAAM,IAAIQ,KAAJ,CACH,sEADG,CAAN;AAGD;;AAED,WAAO,KAAKR,KAAL,CAAWe,GAAX,CAAeV,GAAf,CAAP;AACD;;AAhF8B","sourcesContent":["import manager, {\n  Store,\n  StoreConfig,\n  CachingConfig,\n  MultiCache,\n} from \"cache-manager\"\nimport fs from \"fs-extra\"\nimport * as fsStore from \"../cache/cache-fs\"\nimport path from \"path\"\n\nconst MAX_CACHE_SIZE = 250\nconst TTL = Number.MAX_SAFE_INTEGER\n\ninterface ICacheProperties {\n  name?: string\n  store?: Store\n}\n\nexport default class GatsbyCache {\n  public name: string\n  public store: Store\n  public directory: string\n  // TODO: remove `.cache` in v4. This is compat mode - cache-manager cache implementation\n  // expose internal cache that gives access to `.del` function that wasn't available in public\n  // cache interface (gatsby-plugin-sharp use it to clear no longer needed data)\n  public cache?: MultiCache\n\n  // @ts-ignore - set & get types are missing from fsStore?\n  constructor({ name = `db`, store = fsStore }: ICacheProperties = {}) {\n    this.name = name\n    this.store = store\n    this.directory = path.join(process.cwd(), `.cache/caches/${name}`)\n  }\n\n  init(): GatsbyCache {\n    fs.ensureDirSync(this.directory)\n\n    const configs: Array<StoreConfig> = [\n      {\n        store: `memory`,\n        max: MAX_CACHE_SIZE,\n        ttl: TTL,\n      },\n      {\n        store: this.store,\n        ttl: TTL,\n        options: {\n          path: this.directory,\n          ttl: TTL,\n        },\n      },\n    ]\n\n    const caches = configs.map(cache => manager.caching(cache))\n\n    this.cache = manager.multiCaching(caches)\n\n    return this\n  }\n\n  async get<T = unknown>(key): Promise<T | undefined> {\n    return new Promise(resolve => {\n      if (!this.cache) {\n        throw new Error(\n          `GatsbyCache wasn't initialised yet, please run the init method first`\n        )\n      }\n      this.cache.get<T>(key, (err, res) => {\n        resolve(err ? undefined : res)\n      })\n    })\n  }\n\n  async set<T>(\n    key: string,\n    value: T,\n    args: CachingConfig = { ttl: TTL }\n  ): Promise<T | undefined> {\n    return new Promise(resolve => {\n      if (!this.cache) {\n        throw new Error(\n          `GatsbyCache wasn't initialised yet, please run the init method first`\n        )\n      }\n      this.cache.set(key, value, args, err => {\n        resolve(err ? undefined : value)\n      })\n    })\n  }\n\n  async del(key: string): Promise<void> {\n    if (!this.cache) {\n      throw new Error(\n        `GatsbyCache wasn't initialised yet, please run the init method first`\n      )\n    }\n\n    return this.cache.del(key)\n  }\n}\n"],"file":"cache.js"}