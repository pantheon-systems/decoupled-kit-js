{"version":3,"sources":["../../src/commands/build-html.ts"],"names":["isPreview","process","env","GATSBY_IS_PREVIEW","devssrWebpackCompiler","needToRecompileSSRBundle","getDevSSRWebpack","gatsby_executing_command","Error","devssrWebpackWatcher","compiler","oldHash","newHash","runWebpack","compilerConfig","stage","directory","isDevSSREnabledAndViable","GATSBY_EXPERIMENTAL_DEV_SSR","Promise","resolve","reject","hooks","invalid","tap","watcher","watch","ignored","err","stats","emitter","emit","suspend","hash","restartWorker","require","ROUTES_DIRECTORY","close","then","doBuildRenderer","webpackConfig","hasErrors","reporter","panicOnBuild","compilation","errors","rendererPath","buildRenderer","program","parentSpan","config","deleteRenderer","fs","remove","e","renderHTMLQueue","workerPool","activity","htmlComponentRendererPath","pages","Stage","BuildHTML","envVars","NODE_ENV","gatsby_log_level","segments","sessionId","Date","now","webpackCompilationHash","store","getState","renderHTML","single","renderHTMLProd","renderHTMLDev","uniqueUnsafeBuiltinUsedStacks","Set","Bluebird","map","pageSegment","renderHTMLResult","paths","htmlRenderMeta","seenErrors","errorMessages","Map","all","Object","entries","previewErrors","pagePath","error","has","stack","set","pagePaths","add","prettyError","errorMessageStr","codeFrame","errorMessage","get","push","value","values","p","join","id","context","dispatch","type","payload","_pagePath","arrayOfUsages","unsafeBuiltinsUsageByPagePath","unsafeUsageStack","tick","length","size","console","warn","unsafeBuiltinUsedStack","warningMessage","BuildHTMLError","constructor","message","getOwnPropertyNames","forEach","key","truncateObjStrings","obj","doBuildPages","buildError","path","pageData","truncatedPageData","pageDataMessage","JSON","stringify","buildHTML","span","buildHTMLPagesAndDeleteStaleArtifacts","pageRenderer","buildUtils","markHtmlDirtyIfResultOfUsedStaticQueryChanged","toRegenerate","toDelete","toCleanupFromTrackedState","calcDirtyHtmlFiles","buildHTMLActivityProgress","createProgress","start","errorPath","ref","match","panic","end","info","keepPageRenderer","publicDir","deletePageDataActivityTimer","activityTimer","removePageFiles"],"mappings":";;;;;;;;AAAA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AAEA;;AAEA;;AACA;;AACA;;AACA;;AACA;;AAGA;;AACA;;;;;;AAKqB;AAErB,MAAMA,SAAS,GAAGC,OAAO,CAACC,GAAR,CAAYC,iBAAZ,KAAmC,MAArD;AAsBA,IAAIC,qBAAJ;AACA,IAAIC,wBAAwB,GAAG,IAA/B;;AACO,MAAMC,gBAAgB,GAAG,MAI3B;AACH,MAAIL,OAAO,CAACC,GAAR,CAAYK,wBAAZ,KAA0C,SAA9C,EAAwD;AACtD,UAAM,IAAIC,KAAJ,CAAW,iDAAX,CAAN;AACD;;AAED,SAAO;AACLC,IAAAA,oBAAoB,EAAEL,qBADjB;AAELA,IAAAA,qBAAqB,EAAGA,qBAAD,CAA4CM,QAF9D;AAGLL,IAAAA;AAHK,GAAP;AAKD,CAdM;;;AAgBP,IAAIM,OAAO,GAAI,EAAf;AACA,IAAIC,OAAO,GAAI,EAAf;;AACA,MAAMC,UAAU,GAAG,CACjBC,cADiB,EAEjBC,KAFiB,EAGjBC,SAHiB,KAOb;AACJ,QAAMC,wBAAwB,GAC5BhB,OAAO,CAACC,GAAR,CAAYgB,2BAAZ,IAA2CH,KAAK,KAAM,cADxD;AAGA,SAAO,IAAII,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AACtC,QAAIJ,wBAAJ,EAA8B;AAC5B,YAAMP,QAAQ,GAAG,sBAAQI,cAAR,CAAjB,CAD4B,CAG5B;AACA;;AACAJ,MAAAA,QAAQ,CAACY,KAAT,CAAeC,OAAf,CAAuBC,GAAvB,CAA4B,uBAA5B,EAAoD,MAAM;AACxDnB,QAAAA,wBAAwB,GAAG,IAA3B;AACD,OAFD;AAIA,YAAMoB,OAAO,GAAGf,QAAQ,CAACgB,KAAT,CACd;AACEC,QAAAA,OAAO,EAAE;AADX,OADc,EAId,CAACC,GAAD,EAAMC,KAAN,KAAgB;AACd;AACAxB,QAAAA,wBAAwB,GAAG,KAA3B;;AACAyB,uBAAQC,IAAR,CAAc,0BAAd;;AACAN,QAAAA,OAAO,CAACO,OAAR;;AAEA,YAAIJ,GAAJ,EAAS;AACP,iBAAOP,MAAM,CAACO,GAAD,CAAb;AACD,SAFD,MAEO;AACLhB,UAAAA,OAAO,GAAG,CAAAiB,KAAK,SAAL,IAAAA,KAAK,WAAL,YAAAA,KAAK,CAAEI,IAAP,KAAgB,EAA1B;;AAEA,gBAAM;AACJC,YAAAA;AADI,cAEFC,OAAO,CAAE,kCAAF,CAFX,CAHK,CAML;;;AACA,cAAIxB,OAAO,KAAM,EAAb,IAAkBC,OAAO,KAAKD,OAAlC,EAA2C;AACzCuB,YAAAA,aAAa,CAAE,GAAElB,SAAU,IAAGoB,2BAAiB,gBAAlC,CAAb;AACD;;AAEDzB,UAAAA,OAAO,GAAGC,OAAV;AAEA,iBAAOQ,OAAO,CAAC;AACbS,YAAAA,KAAK,EAAEA,KADM;AAEbQ,YAAAA,KAAK,EAAE,MACL,IAAIlB,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KACVI,OAAO,CAACY,KAAR,CAAcT,GAAG,IAAKA,GAAG,GAAGP,MAAM,CAACO,GAAD,CAAT,GAAiBR,OAAO,EAAjD,CADF;AAHW,WAAD,CAAd;AAOD;AACF,OAjCa,CAAhB;AAmCAhB,MAAAA,qBAAqB,GAAGqB,OAAxB;AACD,KA7CD,MA6CO;AACL,yBAAMX,cAAN,EAAsBwB,IAAtB,CACE,CAAC;AAAET,QAAAA,KAAF;AAASQ,QAAAA;AAAT,OAAD,KAAsB;AACpBjB,QAAAA,OAAO,CAAC;AAAES,UAAAA,KAAF;AAASQ,UAAAA;AAAT,SAAD,CAAP;AACD,OAHH,EAIET,GAAG,IAAIP,MAAM,CAACO,GAAD,CAJf;AAMD;AACF,GAtDM,CAAP;AAuDD,CAlED;;AAoEA,MAAMW,eAAe,GAAG,OACtBvB,SADsB,EAEtBwB,aAFsB,EAGtBzB,KAHsB,KAIY;AAClC,QAAM;AAAEc,IAAAA,KAAF;AAASQ,IAAAA;AAAT,MAAmB,MAAMxB,UAAU,CAAC2B,aAAD,EAAgBzB,KAAhB,EAAuBC,SAAvB,CAAzC;;AACA,MAAIa,KAAJ,aAAIA,KAAJ,eAAIA,KAAK,CAAEY,SAAP,EAAJ,EAAwB;AACtBC,sBAASC,YAAT,CACE,+CAAuB5B,KAAvB,EAA8Bc,KAAK,CAACe,WAAN,CAAkBC,MAAhD,CADF;AAGD,GANiC,CAQlC;;;AACA,SAAO;AACLC,IAAAA,YAAY,EAAG,GAAE9B,SAAU,IAAGoB,2BAAiB,gBAD1C;AAELP,IAAAA,KAFK;AAGLQ,IAAAA;AAHK,GAAP;AAKD,CAlBD;;AAoBO,MAAMU,aAAa,GAAG,OAC3BC,OAD2B,EAE3BjC,KAF2B,EAG3BkC,UAH2B,KAIO;AAClC,QAAMC,MAAM,GAAG,MAAM,uBAAcF,OAAd,EAAuBA,OAAO,CAAChC,SAA/B,EAA0CD,KAA1C,EAAiD,IAAjD,EAAuD;AAC1EkC,IAAAA;AAD0E,GAAvD,CAArB;AAIA,SAAOV,eAAe,CAACS,OAAO,CAAChC,SAAT,EAAoBkC,MAApB,EAA4BnC,KAA5B,CAAtB;AACD,CAVM,C,CAYP;;;;;AACO,MAAMoC,cAAc,GAAG,MAAOL,YAAP,IAA+C;AAC3E,MAAI;AACF,UAAMM,iBAAGC,MAAH,CAAUP,YAAV,CAAN;AACA,UAAMM,iBAAGC,MAAH,CAAW,GAAEP,YAAa,MAA1B,CAAN;AACD,GAHD,CAGE,OAAOQ,CAAP,EAAU,CACV;AACD;AACF,CAPM;;;;AAaP,MAAMC,eAAe,GAAG,OACtBC,UADsB,EAEtBC,QAFsB,EAGtBC,yBAHsB,EAItBC,KAJsB,EAKtB5C,KAAY,GAAG6C,aAAMC,SALC,KAMJ;AAClB;AACA;AACA,QAAMC,OAA4C,GAAG,CACnD,CAAE,UAAF,EAAa7D,OAAO,CAACC,GAAR,CAAY6D,QAAzB,CADmD,EAEnD,CAAE,0BAAF,EAA6B9D,OAAO,CAACC,GAAR,CAAYK,wBAAzC,CAFmD,EAGnD,CAAE,kBAAF,EAAqBN,OAAO,CAACC,GAAR,CAAY8D,gBAAjC,CAHmD,CAArD;AAMA,QAAMC,QAAQ,GAAG,mBAAMN,KAAN,EAAa,EAAb,CAAjB;AAEA,QAAMO,SAAS,GAAGC,IAAI,CAACC,GAAL,EAAlB;;AAEA,QAAM;AAAEC,IAAAA;AAAF,MAA6BC,aAAMC,QAAN,EAAnC;;AAEA,QAAMC,UAAU,GACdzD,KAAK,KAAM,YAAX,GACIyC,UAAU,CAACiB,MAAX,CAAkBC,cADtB,GAEIlB,UAAU,CAACiB,MAAX,CAAkBE,aAHxB;AAKA,QAAMC,6BAA6B,GAAG,IAAIC,GAAJ,EAAtC;;AAEA,MAAI;AACF,UAAMC,kBAASC,GAAT,CAAad,QAAb,EAAuB,MAAMe,WAAN,IAAqB;AAChD,YAAMC,gBAAgB,GAAG,MAAMT,UAAU,CAAC;AACxCV,QAAAA,OADwC;AAExCJ,QAAAA,yBAFwC;AAGxCwB,QAAAA,KAAK,EAAEF,WAHiC;AAIxCd,QAAAA,SAJwC;AAKxCG,QAAAA;AALwC,OAAD,CAAzC;;AAQA,UAAIrE,SAAJ,EAAe;AACb,cAAMmF,cAAc,GAAGF,gBAAvB;AACA,cAAMG,UAAU,GAAG,IAAIP,GAAJ,EAAnB;AACA,cAAMQ,aAAa,GAAG,IAAIC,GAAJ,EAAtB;AACA,cAAMnE,OAAO,CAACoE,GAAR,CACJC,MAAM,CAACC,OAAP,CAAeN,cAAc,CAACO,aAA9B,EAA6CX,GAA7C,CACE,OAAO,CAACY,QAAD,EAAWC,KAAX,CAAP,KAA6B;AAC3B,cAAI,CAACR,UAAU,CAACS,GAAX,CAAeD,KAAK,CAACE,KAArB,CAAL,EAAkC;AAChCT,YAAAA,aAAa,CAACU,GAAd,CAAkBH,KAAK,CAACE,KAAxB,EAA+B;AAC7BE,cAAAA,SAAS,EAAE,CAACL,QAAD;AADkB,aAA/B;AAGAP,YAAAA,UAAU,CAACa,GAAX,CAAeL,KAAK,CAACE,KAArB;AACA,kBAAMI,WAAW,GAAG,MAAM,mCACxBN,KAAK,CAACE,KADkB,EAEvB,GAAEpC,yBAA0B,MAFL,CAA1B;AAKA,kBAAMyC,eAAe,GAAI,GAAED,WAAW,CAACJ,KAAM,GAC3CI,WAAW,CAACE,SAAZ,GAAyB,OAAMF,WAAW,CAACE,SAAU,IAArD,GAA4D,EAC7D,EAFD;AAIA,kBAAMC,YAAY,GAAGhB,aAAa,CAACiB,GAAd,CAAkBV,KAAK,CAACE,KAAxB,CAArB;AACAO,YAAAA,YAAY,CAACA,YAAb,GAA4BF,eAA5B;AACAd,YAAAA,aAAa,CAACU,GAAd,CAAkBH,KAAK,CAACE,KAAxB,EAA+BO,YAA/B;AACD,WAjBD,MAiBO;AACL,kBAAMA,YAAY,GAAGhB,aAAa,CAACiB,GAAd,CAAkBV,KAAK,CAACE,KAAxB,CAArB;AACAO,YAAAA,YAAY,CAACL,SAAb,CAAuBO,IAAvB,CAA4BZ,QAA5B;AACAN,YAAAA,aAAa,CAACU,GAAd,CAAkBH,KAAK,CAACE,KAAxB,EAA+BO,YAA/B;AACD;AACF,SAxBH,CADI,CAAN;;AA6BA,aAAK,MAAMG,KAAX,IAAoBnB,aAAa,CAACoB,MAAd,EAApB,EAA4C;AAC1C,gBAAMJ,YAAY,GAAI,qEAAoEG,KAAK,CAACR,SAAN,CACvFjB,GADuF,CACnF2B,CAAC,IAAK,KAAIA,CAAE,EADuE,EAEvFC,IAFuF,CAEjF,IAFiF,CAE5E,OAAMH,KAAK,CAACH,YAAa,EAFvC;;AAGA3D,4BAASkD,KAAT,CAAe;AACbgB,YAAAA,EAAE,EAAG,OADQ;AAEbC,YAAAA,OAAO,EAAE;AAAER,cAAAA;AAAF;AAFI,WAAf;AAID;AACF;;AAED,UAAItF,KAAK,KAAM,YAAf,EAA4B;AAC1B,cAAMoE,cAAc,GAAGF,gBAAvB;;AACAX,qBAAMwC,QAAN,CAAe;AACbC,UAAAA,IAAI,EAAG,gBADM;AAEbC,UAAAA,OAAO,EAAEhC;AAFI,SAAf;;AAKA,aAAK,MAAM,CAACiC,SAAD,EAAYC,aAAZ,CAAX,IAAyC1B,MAAM,CAACC,OAAP,CACvCN,cAAc,CAACgC,6BADwB,CAAzC,EAEG;AACD,eAAK,MAAMC,gBAAX,IAA+BF,aAA/B,EAA8C;AAC5CtC,YAAAA,6BAA6B,CAACqB,GAA9B,CAAkCmB,gBAAlC;AACD;AACF;AACF;;AAED,UAAI3D,QAAQ,IAAIA,QAAQ,CAAC4D,IAAzB,EAA+B;AAC7B5D,QAAAA,QAAQ,CAAC4D,IAAT,CAAcrC,WAAW,CAACsC,MAA1B;AACD;AACF,KAxEK,CAAN;AAyED,GA1ED,CA0EE,OAAOhE,CAAP,EAAU;AAAA;;AACV,QAAIA,CAAJ,aAAIA,CAAJ,6BAAIA,CAAC,CAAEuD,OAAP,uCAAI,WAAYM,6BAAhB,EAA+C;AAC7C,WAAK,MAAM,CAACF,SAAD,EAAYC,aAAZ,CAAX,IAAyC1B,MAAM,CAACC,OAAP,CACvCnC,CAAC,CAACuD,OAAF,CAAUM,6BAD6B,CAAzC,EAEG;AACD;AACA,aAAK,MAAMC,gBAAX,IAA+BF,aAA/B,EAA8C;AAC5CtC,UAAAA,6BAA6B,CAACqB,GAA9B,CAAkCmB,gBAAlC;AACD;AACF;AACF;;AACD,UAAM9D,CAAN;AACD,GAtFD,SAsFU;AACR,QAAIsB,6BAA6B,CAAC2C,IAA9B,GAAqC,CAAzC,EAA4C;AAC1CC,MAAAA,OAAO,CAACC,IAAR,CACG,8EADH;;AAGAnD,mBAAMwC,QAAN,CAAe;AACbC,QAAAA,IAAI,EAAG;AADM,OAAf;AAGD;;AAED,SAAK,MAAMW,sBAAX,IAAqC9C,6BAArC,EAAoE;AAClE,YAAMsB,WAAW,GAAG,MAAM,mCACxBwB,sBADwB,EAEvB,GAAEhE,yBAA0B,MAFL,CAA1B;AAKA,YAAMiE,cAAc,GAAI,GAAEzB,WAAW,CAACJ,KAAM,GAC1CI,WAAW,CAACE,SAAZ,GAAyB,OAAMF,WAAW,CAACE,SAAU,IAArD,GAA4D,EAC7D,EAFD;;AAIA1D,wBAAS+E,IAAT,CAAcE,cAAd;AACD;AACF;AACF,CAzID;;AA2IA,MAAMC,cAAN,SAA6BpH,KAA7B,CAAmC;AACjC4F,EAAAA,SAAS,GAAI,EAAJ;;AAKTyB,EAAAA,WAAW,CAACjC,KAAD,EAAe;AACxB,UAAMA,KAAK,CAACkC,OAAZ,EADwB,CAGxB;AACA;;AACAtC,IAAAA,MAAM,CAACuC,mBAAP,CAA2BnC,KAA3B,EAAkCoC,OAAlC,CAA0CC,GAAG,IAAI;AAC/C,WAAKA,GAAL,IAAYrC,KAAK,CAACqC,GAAD,CAAjB;AACD,KAFD;AAGD;;AAdgC;;AAiBnC,MAAMC,kBAAkB,GAAIC,GAAD,IAAmC;AAC5D;AACA;AACA,OAAK,MAAMF,GAAX,IAAkBE,GAAlB,EAAuB;AACrB,QAAI,OAAOA,GAAG,CAACF,GAAD,CAAV,KAAqB,QAAzB,EAAkC;AAChCC,MAAAA,kBAAkB,CAACC,GAAG,CAACF,GAAD,CAAJ,CAAlB;AACD,KAFD,MAEO,IAAI,OAAOE,GAAG,CAACF,GAAD,CAAV,KAAqB,QAAzB,EAAkC;AACvCE,MAAAA,GAAG,CAACF,GAAD,CAAH,GAAW,sBAASE,GAAG,CAACF,GAAD,CAAZ,EAAmB;AAAEX,QAAAA,MAAM,EAAE;AAAV,OAAnB,CAAX;AACD;AACF;;AAED,SAAOa,GAAP;AACD,CAZD;;AAcO,MAAMC,YAAY,GAAG,OAC1BtF,YAD0B,EAE1BkD,SAF0B,EAG1BvC,QAH0B,EAI1BD,UAJ0B,EAK1BzC,KAL0B,KAMR;AAClB,MAAI;AACF,UAAMwC,eAAe,CAACC,UAAD,EAAaC,QAAb,EAAuBX,YAAvB,EAAqCkD,SAArC,EAAgDjF,KAAhD,CAArB;AACD,GAFD,CAEE,OAAO6E,KAAP,EAAc;AAAA;;AACd,UAAMM,WAAW,GAAG,MAAM,mCACxBN,KAAK,CAACE,KADkB,EAEvB,GAAEhD,YAAa,MAFQ,CAA1B;AAKA,UAAMuF,UAAU,GAAG,IAAIT,cAAJ,CAAmB1B,WAAnB,CAAnB;AACAmC,IAAAA,UAAU,CAACxB,OAAX,GAAqBjB,KAAK,CAACiB,OAA3B;;AAEA,QAAIjB,KAAJ,aAAIA,KAAJ,iCAAIA,KAAK,CAAEiB,OAAX,2CAAI,eAAgByB,IAApB,EAA0B;AACxB,YAAMC,QAAQ,GAAG,MAAM,8BAAY3C,KAAK,CAACiB,OAAN,CAAcyB,IAA1B,CAAvB;AACA,YAAME,iBAAiB,GAAGN,kBAAkB,CAACK,QAAD,CAA5C;AAEA,YAAME,eAAe,GAAI,sDACvB7C,KAAK,CAACiB,OAAN,CAAcyB,IACf,MAAKI,IAAI,CAACC,SAAL,CAAeH,iBAAf,EAAkC,IAAlC,EAAwC,CAAxC,CAA2C,EAFjD,CAJwB,CAQxB;AACA;;AACA,UAAIxI,SAAJ,EAAe;AACb0C,0BAASkD,KAAT,CAAe;AACbgB,UAAAA,EAAE,EAAG,OADQ;AAEbC,UAAAA,OAAO,EAAE;AAAE0B,YAAAA,QAAQ,EAAEE;AAAZ,WAFI;AAGb7C,UAAAA,KAAK,EAAEyC;AAHM,SAAf;AAKD,OAND,MAMO;AACL3F,0BAASkD,KAAT,CAAe6C,eAAf;AACD;AACF,KA5Ba,CA8Bd;;;AACA,QAAI,CAACzI,SAAL,EAAgB;AACd,YAAMqI,UAAN;AACD;AACF;AACF,CA5CM,C,CA8CP;;;;;AACO,MAAMO,SAAS,GAAG,OAAO;AAC9B5F,EAAAA,OAD8B;AAE9BjC,EAAAA,KAF8B;AAG9BiF,EAAAA,SAH8B;AAI9BvC,EAAAA,QAJ8B;AAK9BD,EAAAA;AAL8B,CAAP,KAYJ;AACnB,QAAM;AAAEV,IAAAA;AAAF,MAAmB,MAAMC,aAAa,CAACC,OAAD,EAAUjC,KAAV,EAAiB0C,QAAQ,CAACoF,IAA1B,CAA5C;AACA,QAAMT,YAAY,CAACtF,YAAD,EAAekD,SAAf,EAA0BvC,QAA1B,EAAoCD,UAApC,EAAgDzC,KAAhD,CAAlB;AACD,CAfM;;;;AAiBA,eAAe+H,qCAAf,CAAqD;AAC1DtF,EAAAA,UAD0D;AAE1DP,EAAAA,UAF0D;AAG1DD,EAAAA;AAH0D,CAArD,EAWJ;AACD,QAAM+F,YAAY,GAAI,GAAE/F,OAAO,CAAChC,SAAU,IAAGoB,2BAAiB,gBAA9D;AACA4G,EAAAA,UAAU,CAACC,6CAAX;AAEA,QAAM;AAAEC,IAAAA,YAAF;AAAgBC,IAAAA,QAAhB;AAA0BC,IAAAA;AAA1B,MACJJ,UAAU,CAACK,kBAAX,CAA8B/E,aAAMC,QAAN,EAA9B,CADF;;AAGAD,eAAMwC,QAAN,CAAe;AACbC,IAAAA,IAAI,EAAG,4BADM;AAEbC,IAAAA,OAAO,EAAEoC;AAFI,GAAf;;AAKA,MAAIF,YAAY,CAAC5B,MAAb,GAAsB,CAA1B,EAA6B;AAC3B,UAAMgC,yBAAyB,GAAG5G,kBAAS6G,cAAT,CAC/B,gCAD+B,EAEhCL,YAAY,CAAC5B,MAFmB,EAGhC,CAHgC,EAIhC;AACErE,MAAAA;AADF,KAJgC,CAAlC;;AAQAqG,IAAAA,yBAAyB,CAACE,KAA1B;;AACA,QAAI;AACF,YAAMpB,YAAY,CAChBW,YADgB,EAEhBG,YAFgB,EAGhBI,yBAHgB,EAIhB9F,UAJgB,EAKhBI,aAAMC,SALU,CAAlB;AAOD,KARD,CAQE,OAAOjC,GAAP,EAAY;AACZ,UAAIgF,EAAE,GAAI,OAAV,CADY,CACK;;AACjB,YAAMC,OAAO,GAAG;AACd4C,QAAAA,SAAS,EAAE7H,GAAG,CAACiF,OAAJ,IAAejF,GAAG,CAACiF,OAAJ,CAAYyB,IADxB;AAEdoB,QAAAA,GAAG,EAAG;AAFQ,OAAhB;AAKA,YAAMC,KAAK,GAAG/H,GAAG,CAACkG,OAAJ,CAAY6B,KAAZ,CACZ,yFADY,CAAd;;AAGA,UAAIA,KAAK,IAAIA,KAAK,CAAC,CAAD,CAAlB,EAAuB;AACrB/C,QAAAA,EAAE,GAAI,OAAN;AACAC,QAAAA,OAAO,CAAC6C,GAAR,GAAcC,KAAK,CAAC,CAAD,CAAnB;AACD;;AAEDL,MAAAA,yBAAyB,CAACM,KAA1B,CAAgC;AAC9BhD,QAAAA,EAD8B;AAE9BC,QAAAA,OAF8B;AAG9BjB,QAAAA,KAAK,EAAEhE;AAHuB,OAAhC;AAKD;;AACD0H,IAAAA,yBAAyB,CAACO,GAA1B;AACD,GAxCD,MAwCO;AACLnH,sBAASoH,IAAT,CAAe,kDAAf;AACD;;AAED,MAAI,QAA2B,GAA3B,IAAiC,CAAC9G,OAAO,CAAC+G,gBAA9C,EAAgE;AAC9D,QAAI;AACF,YAAM5G,cAAc,CAAC4F,YAAD,CAApB;AACD,KAFD,CAEE,OAAOnH,GAAP,EAAY,CACZ;AACD;AACF;;AAED,MAAIuH,QAAQ,CAAC7B,MAAT,GAAkB,CAAtB,EAAyB;AACvB,UAAM0C,SAAS,GAAG1B,IAAI,CAAC3B,IAAL,CAAU3D,OAAO,CAAChC,SAAlB,EAA8B,QAA9B,CAAlB;;AACA,UAAMiJ,2BAA2B,GAAGvH,kBAASwH,aAAT,CACjC,2BADiC,CAApC;;AAGAD,IAAAA,2BAA2B,CAACT,KAA5B;AACA,UAAMR,UAAU,CAACmB,eAAX,CAA2BH,SAA3B,EAAsCb,QAAtC,CAAN;AAEAc,IAAAA,2BAA2B,CAACJ,GAA5B;AACD;;AAED,SAAO;AAAEX,IAAAA,YAAF;AAAgBC,IAAAA;AAAhB,GAAP;AACD","sourcesContent":["import Bluebird from \"bluebird\"\nimport fs from \"fs-extra\"\nimport reporter from \"gatsby-cli/lib/reporter\"\nimport { createErrorFromString } from \"gatsby-cli/lib/reporter/errors\"\nimport { chunk, truncate } from \"lodash\"\nimport { build, watch } from \"../utils/webpack/bundle\"\nimport * as path from \"path\"\n\nimport { emitter, store } from \"../redux\"\nimport { IWebpackWatchingPauseResume } from \"../utils/start-server\"\nimport webpack from \"webpack\"\nimport webpackConfig from \"../utils/webpack.config\"\nimport { structureWebpackErrors } from \"../utils/webpack-error-utils\"\nimport * as buildUtils from \"./build-utils\"\nimport { getPageData } from \"../utils/get-page-data\"\n\nimport { Span } from \"opentracing\"\nimport { IProgram, Stage } from \"./types\"\nimport { ROUTES_DIRECTORY } from \"../constants\"\nimport { PackageJson } from \"../..\"\nimport { IPageDataWithQueryResult } from \"../utils/page-data\"\n\nimport type { GatsbyWorkerPool } from \"../utils/worker/pool\"\ntype IActivity = any // TODO\n\nconst isPreview = process.env.GATSBY_IS_PREVIEW === `true`\n\nexport interface IBuildArgs extends IProgram {\n  directory: string\n  sitePackageJson: PackageJson\n  prefixPaths: boolean\n  noUglify: boolean\n  logPages: boolean\n  writeToFile: boolean\n  profile: boolean\n  graphqlTracing: boolean\n  openTracingConfigFile: string\n  // TODO remove in v4\n  keepPageRenderer: boolean\n}\n\ninterface IBuildRendererResult {\n  rendererPath: string\n  stats: webpack.Stats\n  close: ReturnType<typeof watch>[\"close\"]\n}\n\nlet devssrWebpackCompiler: webpack.Watching | undefined\nlet needToRecompileSSRBundle = true\nexport const getDevSSRWebpack = (): {\n  devssrWebpackWatcher: IWebpackWatchingPauseResume\n  devssrWebpackCompiler: webpack.Compiler\n  needToRecompileSSRBundle: boolean\n} => {\n  if (process.env.gatsby_executing_command !== `develop`) {\n    throw new Error(`This function can only be called in development`)\n  }\n\n  return {\n    devssrWebpackWatcher: devssrWebpackCompiler as webpack.Watching,\n    devssrWebpackCompiler: (devssrWebpackCompiler as webpack.Watching).compiler,\n    needToRecompileSSRBundle,\n  }\n}\n\nlet oldHash = ``\nlet newHash = ``\nconst runWebpack = (\n  compilerConfig,\n  stage: Stage,\n  directory: string\n): Promise<{\n  stats: webpack.Stats\n  close: ReturnType<typeof watch>[\"close\"]\n}> => {\n  const isDevSSREnabledAndViable =\n    process.env.GATSBY_EXPERIMENTAL_DEV_SSR && stage === `develop-html`\n\n  return new Promise((resolve, reject) => {\n    if (isDevSSREnabledAndViable) {\n      const compiler = webpack(compilerConfig)\n\n      // because of this line we can't use our watch helper\n      // These things should use emitter\n      compiler.hooks.invalid.tap(`ssr file invalidation`, () => {\n        needToRecompileSSRBundle = true\n      })\n\n      const watcher = compiler.watch(\n        {\n          ignored: /node_modules/,\n        },\n        (err, stats) => {\n          // this runs multiple times\n          needToRecompileSSRBundle = false\n          emitter.emit(`DEV_SSR_COMPILATION_DONE`)\n          watcher.suspend()\n\n          if (err) {\n            return reject(err)\n          } else {\n            newHash = stats?.hash || ``\n\n            const {\n              restartWorker,\n            } = require(`../utils/dev-ssr/render-dev-html`)\n            // Make sure we use the latest version during development\n            if (oldHash !== `` && newHash !== oldHash) {\n              restartWorker(`${directory}/${ROUTES_DIRECTORY}render-page.js`)\n            }\n\n            oldHash = newHash\n\n            return resolve({\n              stats: stats as webpack.Stats,\n              close: () =>\n                new Promise((resolve, reject): void =>\n                  watcher.close(err => (err ? reject(err) : resolve()))\n                ),\n            })\n          }\n        }\n      )\n      devssrWebpackCompiler = watcher\n    } else {\n      build(compilerConfig).then(\n        ({ stats, close }) => {\n          resolve({ stats, close })\n        },\n        err => reject(err)\n      )\n    }\n  })\n}\n\nconst doBuildRenderer = async (\n  directory: string,\n  webpackConfig: webpack.Configuration,\n  stage: Stage\n): Promise<IBuildRendererResult> => {\n  const { stats, close } = await runWebpack(webpackConfig, stage, directory)\n  if (stats?.hasErrors()) {\n    reporter.panicOnBuild(\n      structureWebpackErrors(stage, stats.compilation.errors)\n    )\n  }\n\n  // render-page.js is hard coded in webpack.config\n  return {\n    rendererPath: `${directory}/${ROUTES_DIRECTORY}render-page.js`,\n    stats,\n    close,\n  }\n}\n\nexport const buildRenderer = async (\n  program: IProgram,\n  stage: Stage,\n  parentSpan?: IActivity\n): Promise<IBuildRendererResult> => {\n  const config = await webpackConfig(program, program.directory, stage, null, {\n    parentSpan,\n  })\n\n  return doBuildRenderer(program.directory, config, stage)\n}\n\n// TODO remove after v4 release and update cloud internals\nexport const deleteRenderer = async (rendererPath: string): Promise<void> => {\n  try {\n    await fs.remove(rendererPath)\n    await fs.remove(`${rendererPath}.map`)\n  } catch (e) {\n    // This function will fail on Windows with no further consequences.\n  }\n}\nexport interface IRenderHtmlResult {\n  unsafeBuiltinsUsageByPagePath: Record<string, Array<string>>\n  previewErrors: Record<string, any>\n}\n\nconst renderHTMLQueue = async (\n  workerPool: GatsbyWorkerPool,\n  activity: IActivity,\n  htmlComponentRendererPath: string,\n  pages: Array<string>,\n  stage: Stage = Stage.BuildHTML\n): Promise<void> => {\n  // We need to only pass env vars that are set programmatically in gatsby-cli\n  // to child process. Other vars will be picked up from environment.\n  const envVars: Array<[string, string | undefined]> = [\n    [`NODE_ENV`, process.env.NODE_ENV],\n    [`gatsby_executing_command`, process.env.gatsby_executing_command],\n    [`gatsby_log_level`, process.env.gatsby_log_level],\n  ]\n\n  const segments = chunk(pages, 50)\n\n  const sessionId = Date.now()\n\n  const { webpackCompilationHash } = store.getState()\n\n  const renderHTML =\n    stage === `build-html`\n      ? workerPool.single.renderHTMLProd\n      : workerPool.single.renderHTMLDev\n\n  const uniqueUnsafeBuiltinUsedStacks = new Set<string>()\n\n  try {\n    await Bluebird.map(segments, async pageSegment => {\n      const renderHTMLResult = await renderHTML({\n        envVars,\n        htmlComponentRendererPath,\n        paths: pageSegment,\n        sessionId,\n        webpackCompilationHash,\n      })\n\n      if (isPreview) {\n        const htmlRenderMeta = renderHTMLResult as IRenderHtmlResult\n        const seenErrors = new Set()\n        const errorMessages = new Map()\n        await Promise.all(\n          Object.entries(htmlRenderMeta.previewErrors).map(\n            async ([pagePath, error]) => {\n              if (!seenErrors.has(error.stack)) {\n                errorMessages.set(error.stack, {\n                  pagePaths: [pagePath],\n                })\n                seenErrors.add(error.stack)\n                const prettyError = await createErrorFromString(\n                  error.stack,\n                  `${htmlComponentRendererPath}.map`\n                )\n\n                const errorMessageStr = `${prettyError.stack}${\n                  prettyError.codeFrame ? `\\n\\n${prettyError.codeFrame}\\n` : ``\n                }`\n\n                const errorMessage = errorMessages.get(error.stack)\n                errorMessage.errorMessage = errorMessageStr\n                errorMessages.set(error.stack, errorMessage)\n              } else {\n                const errorMessage = errorMessages.get(error.stack)\n                errorMessage.pagePaths.push(pagePath)\n                errorMessages.set(error.stack, errorMessage)\n              }\n            }\n          )\n        )\n\n        for (const value of errorMessages.values()) {\n          const errorMessage = `The following page(s) saw this error when building their HTML:\\n\\n${value.pagePaths\n            .map(p => `- ${p}`)\n            .join(`\\n`)}\\n\\n${value.errorMessage}`\n          reporter.error({\n            id: `95314`,\n            context: { errorMessage },\n          })\n        }\n      }\n\n      if (stage === `build-html`) {\n        const htmlRenderMeta = renderHTMLResult as IRenderHtmlResult\n        store.dispatch({\n          type: `HTML_GENERATED`,\n          payload: pageSegment,\n        })\n\n        for (const [_pagePath, arrayOfUsages] of Object.entries(\n          htmlRenderMeta.unsafeBuiltinsUsageByPagePath\n        )) {\n          for (const unsafeUsageStack of arrayOfUsages) {\n            uniqueUnsafeBuiltinUsedStacks.add(unsafeUsageStack)\n          }\n        }\n      }\n\n      if (activity && activity.tick) {\n        activity.tick(pageSegment.length)\n      }\n    })\n  } catch (e) {\n    if (e?.context?.unsafeBuiltinsUsageByPagePath) {\n      for (const [_pagePath, arrayOfUsages] of Object.entries(\n        e.context.unsafeBuiltinsUsageByPagePath\n      )) {\n        // @ts-ignore TS doesn't know arrayOfUsages is Iterable\n        for (const unsafeUsageStack of arrayOfUsages) {\n          uniqueUnsafeBuiltinUsedStacks.add(unsafeUsageStack)\n        }\n      }\n    }\n    throw e\n  } finally {\n    if (uniqueUnsafeBuiltinUsedStacks.size > 0) {\n      console.warn(\n        `Unsafe builtin method was used, future builds will need to rebuild all pages`\n      )\n      store.dispatch({\n        type: `SSR_USED_UNSAFE_BUILTIN`,\n      })\n    }\n\n    for (const unsafeBuiltinUsedStack of uniqueUnsafeBuiltinUsedStacks) {\n      const prettyError = await createErrorFromString(\n        unsafeBuiltinUsedStack,\n        `${htmlComponentRendererPath}.map`\n      )\n\n      const warningMessage = `${prettyError.stack}${\n        prettyError.codeFrame ? `\\n\\n${prettyError.codeFrame}\\n` : ``\n      }`\n\n      reporter.warn(warningMessage)\n    }\n  }\n}\n\nclass BuildHTMLError extends Error {\n  codeFrame = ``\n  context?: {\n    path: string\n  }\n\n  constructor(error: Error) {\n    super(error.message)\n\n    // We must use getOwnProperty because keys like `stack` are not enumerable,\n    // but we want to copy over the entire error\n    Object.getOwnPropertyNames(error).forEach(key => {\n      this[key] = error[key]\n    })\n  }\n}\n\nconst truncateObjStrings = (obj): IPageDataWithQueryResult => {\n  // Recursively truncate strings nested in object\n  // These objs can be quite large, but we want to preserve each field\n  for (const key in obj) {\n    if (typeof obj[key] === `object`) {\n      truncateObjStrings(obj[key])\n    } else if (typeof obj[key] === `string`) {\n      obj[key] = truncate(obj[key], { length: 250 })\n    }\n  }\n\n  return obj\n}\n\nexport const doBuildPages = async (\n  rendererPath: string,\n  pagePaths: Array<string>,\n  activity: IActivity,\n  workerPool: GatsbyWorkerPool,\n  stage: Stage\n): Promise<void> => {\n  try {\n    await renderHTMLQueue(workerPool, activity, rendererPath, pagePaths, stage)\n  } catch (error) {\n    const prettyError = await createErrorFromString(\n      error.stack,\n      `${rendererPath}.map`\n    )\n\n    const buildError = new BuildHTMLError(prettyError)\n    buildError.context = error.context\n\n    if (error?.context?.path) {\n      const pageData = await getPageData(error.context.path)\n      const truncatedPageData = truncateObjStrings(pageData)\n\n      const pageDataMessage = `Page data from page-data.json for the failed page \"${\n        error.context.path\n      }\": ${JSON.stringify(truncatedPageData, null, 2)}`\n\n      // This is our only error during preview so customize it a bit + add the\n      // pretty build error.\n      if (isPreview) {\n        reporter.error({\n          id: `95314`,\n          context: { pageData: pageDataMessage },\n          error: buildError,\n        })\n      } else {\n        reporter.error(pageDataMessage)\n      }\n    }\n\n    // Don't crash the builder when we're in preview-mode.\n    if (!isPreview) {\n      throw buildError\n    }\n  }\n}\n\n// TODO remove in v4 - this could be a \"public\" api\nexport const buildHTML = async ({\n  program,\n  stage,\n  pagePaths,\n  activity,\n  workerPool,\n}: {\n  program: IProgram\n  stage: Stage\n  pagePaths: Array<string>\n  activity: IActivity\n  workerPool: GatsbyWorkerPool\n}): Promise<void> => {\n  const { rendererPath } = await buildRenderer(program, stage, activity.span)\n  await doBuildPages(rendererPath, pagePaths, activity, workerPool, stage)\n}\n\nexport async function buildHTMLPagesAndDeleteStaleArtifacts({\n  workerPool,\n  parentSpan,\n  program,\n}: {\n  workerPool: GatsbyWorkerPool\n  parentSpan?: Span\n  program: IBuildArgs\n}): Promise<{\n  toRegenerate: Array<string>\n  toDelete: Array<string>\n}> {\n  const pageRenderer = `${program.directory}/${ROUTES_DIRECTORY}render-page.js`\n  buildUtils.markHtmlDirtyIfResultOfUsedStaticQueryChanged()\n\n  const { toRegenerate, toDelete, toCleanupFromTrackedState } =\n    buildUtils.calcDirtyHtmlFiles(store.getState())\n\n  store.dispatch({\n    type: `HTML_TRACKED_PAGES_CLEANUP`,\n    payload: toCleanupFromTrackedState,\n  })\n\n  if (toRegenerate.length > 0) {\n    const buildHTMLActivityProgress = reporter.createProgress(\n      `Building static HTML for pages`,\n      toRegenerate.length,\n      0,\n      {\n        parentSpan,\n      }\n    )\n    buildHTMLActivityProgress.start()\n    try {\n      await doBuildPages(\n        pageRenderer,\n        toRegenerate,\n        buildHTMLActivityProgress,\n        workerPool,\n        Stage.BuildHTML\n      )\n    } catch (err) {\n      let id = `95313` // TODO: verify error IDs exist\n      const context = {\n        errorPath: err.context && err.context.path,\n        ref: ``,\n      }\n\n      const match = err.message.match(\n        /ReferenceError: (window|document|localStorage|navigator|alert|location) is not defined/i\n      )\n      if (match && match[1]) {\n        id = `95312`\n        context.ref = match[1]\n      }\n\n      buildHTMLActivityProgress.panic({\n        id,\n        context,\n        error: err,\n      })\n    }\n    buildHTMLActivityProgress.end()\n  } else {\n    reporter.info(`There are no new or changed html files to build.`)\n  }\n\n  if (_CFLAGS_.GATSBY_MAJOR !== `4` && !program.keepPageRenderer) {\n    try {\n      await deleteRenderer(pageRenderer)\n    } catch (err) {\n      // pass through\n    }\n  }\n\n  if (toDelete.length > 0) {\n    const publicDir = path.join(program.directory, `public`)\n    const deletePageDataActivityTimer = reporter.activityTimer(\n      `Delete previous page data`\n    )\n    deletePageDataActivityTimer.start()\n    await buildUtils.removePageFiles(publicDir, toDelete)\n\n    deletePageDataActivityTimer.end()\n  }\n\n  return { toRegenerate, toDelete }\n}\n"],"file":"build-html.js"}