{"version":3,"sources":["../../../../src/bootstrap/load-plugins/utils/flatten-plugins.ts"],"names":["flattenPlugins","plugins","flattened","extractPlugins","plugin","subPluginPaths","subPluginPath","segments","split","roots","pluginOptions","segment","flat","map","root","forEach","subPlugin","push"],"mappings":";;;;;AAEA;AACA;AACA;AACO,MAAMA,cAAc,GACzBC,OAD4B,IAEL;AACvB,QAAMC,SAA6B,GAAG,EAAtC;;AACA,QAAMC,cAAc,GAAIC,MAAD,IAA+B;AACpD,QAAIA,MAAM,CAACC,cAAX,EAA2B;AACzB,WAAK,MAAMC,aAAX,IAA4BF,MAAM,CAACC,cAAnC,EAAmD;AACjD;AACA;AACA;AACA;AACA,cAAME,QAAQ,GAAGD,aAAa,CAACE,KAAd,CAAqB,GAArB,CAAjB;AACA,YAAIC,KAAiB,GAAG,CAACL,MAAM,CAACM,aAAR,CAAxB;;AACA,aAAK,MAAMC,OAAX,IAAsBJ,QAAtB,EAAgC;AAC9B,cAAII,OAAO,KAAM,IAAjB,EAAsB;AACpBF,YAAAA,KAAK,GAAGA,KAAK,CAACG,IAAN,EAAR;AACD,WAFD,MAEO;AACLH,YAAAA,KAAK,GAAGA,KAAK,CAACI,GAAN,CAAUC,IAAI,IAAIA,IAAI,CAACH,OAAD,CAAtB,CAAR;AACD;AACF;;AACDF,QAAAA,KAAK,GAAGA,KAAK,CAACG,IAAN,EAAR;AAEAH,QAAAA,KAAK,CAACM,OAAN,CAAcC,SAAS,IAAI;AACzBd,UAAAA,SAAS,CAACe,IAAV,CAAeD,SAAf;AACAb,UAAAA,cAAc,CAACa,SAAD,CAAd;AACD,SAHD;AAID;AACF;AACF,GAxBD;;AA0BAf,EAAAA,OAAO,CAACc,OAAR,CAAgBX,MAAM,IAAI;AACxBF,IAAAA,SAAS,CAACe,IAAV,CAAeb,MAAf;AACAD,IAAAA,cAAc,CAACC,MAAD,CAAd;AACD,GAHD;AAKA,SAAOF,SAAP;AACD,CApCM","sourcesContent":["import { IPluginInfo } from \"../types\"\n\n// Create a \"flattened\" array of plugins with all subplugins\n// brought to the top-level. This simplifies running gatsby-* files\n// for subplugins.\nexport const flattenPlugins = (\n  plugins: Array<IPluginInfo>\n): Array<IPluginInfo> => {\n  const flattened: Array<IPluginInfo> = []\n  const extractPlugins = (plugin: IPluginInfo): void => {\n    if (plugin.subPluginPaths) {\n      for (const subPluginPath of plugin.subPluginPaths) {\n        // @pieh:\n        // subPluginPath can look like someOption.randomFieldThatIsMarkedAsSubplugins\n        // Reason for doing stringified path with . separator was that it was just easier to prevent duplicates\n        // in subPluginPaths array (as each subplugin in the gatsby-config would add subplugin path).\n        const segments = subPluginPath.split(`.`)\n        let roots: Array<any> = [plugin.pluginOptions]\n        for (const segment of segments) {\n          if (segment === `[]`) {\n            roots = roots.flat()\n          } else {\n            roots = roots.map(root => root[segment])\n          }\n        }\n        roots = roots.flat()\n\n        roots.forEach(subPlugin => {\n          flattened.push(subPlugin)\n          extractPlugins(subPlugin)\n        })\n      }\n    }\n  }\n\n  plugins.forEach(plugin => {\n    flattened.push(plugin)\n    extractPlugins(plugin)\n  })\n\n  return flattened\n}\n"],"file":"flatten-plugins.js"}