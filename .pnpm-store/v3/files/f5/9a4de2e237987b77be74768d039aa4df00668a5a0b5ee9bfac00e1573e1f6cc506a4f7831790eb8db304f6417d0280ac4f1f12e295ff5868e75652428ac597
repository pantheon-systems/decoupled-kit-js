{"version":3,"sources":["../../../src/datastore/lmdb/lmdb-datastore.ts"],"names":["lmdbDatastore","getNode","getTypes","countNodes","iterateNodes","iterateNodesByType","updateDataStore","ready","runQuery","getNodes","getNodesByType","preSyncDeletedNodeIdsCache","Set","getDefaultDbPath","dbFileName","process","env","NODE_ENV","FORCE_TEST_DATABASE_ID","JEST_WORKER_ID","cwd","fullDbPath","rootDb","databases","getRootDb","Error","name","path","compression","getDatabases","globalThis","__GATSBY_OPEN_LMDBS","Map","get","nodes","openDB","cache","expirer","nodesByType","dupSort","metadata","useVersions","indexes","set","result","Array","from","type","nodesDb","GatsbyIterable","getKeys","snapshot","map","nodeId","undefined","filter","Boolean","getValues","id","has","asArray","typeName","stats","getStats","Math","max","Number","entryCount","size","getValuesCount","args","GATSBY_EXPERIMENTAL_LMDB_INDEXES","datastore","Promise","resolve","lastOperationPromise","action","dbs","transactionSync","clearSync","clearIndexes","operationPromise","all","delete","payload","add","then","clear","setupLmdbStore","dbPath","state","emitter","on"],"mappings":"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","sourcesContent":["import { RootDatabase, open, ArrayLikeIterable } from \"lmdb\"\n// import { performance } from \"perf_hooks\"\nimport { ActionsUnion, IGatsbyNode } from \"../../redux/types\"\nimport { updateNodes } from \"./updates/nodes\"\nimport { updateNodesByType } from \"./updates/nodes-by-type\"\nimport { IDataStore, ILmdbDatabases, IQueryResult } from \"../types\"\nimport { emitter, replaceReducer } from \"../../redux\"\nimport { GatsbyIterable } from \"../common/iterable\"\nimport { doRunQuery } from \"./query/run-query\"\nimport {\n  IRunFilterArg,\n  runFastFiltersAndSort,\n} from \"../in-memory/run-fast-filters\"\n\nconst lmdbDatastore = {\n  getNode,\n  getTypes,\n  countNodes,\n  iterateNodes,\n  iterateNodesByType,\n  updateDataStore,\n  ready,\n  runQuery,\n\n  // deprecated:\n  getNodes,\n  getNodesByType,\n}\n\nconst preSyncDeletedNodeIdsCache = new Set()\n\nfunction getDefaultDbPath(): string {\n  const dbFileName =\n    process.env.NODE_ENV === `test`\n      ? `test-datastore-${\n          // FORCE_TEST_DATABASE_ID will be set if this gets executed in worker context\n          // when running jest tests. JEST_WORKER_ID will be set when this gets executed directly\n          // in test context (jest will use jest-worker internally).\n          process.env.FORCE_TEST_DATABASE_ID ?? process.env.JEST_WORKER_ID\n        }`\n      : `datastore`\n\n  return process.cwd() + `/.cache/data/` + dbFileName\n}\n\nlet fullDbPath\nlet rootDb\nlet databases\n\nfunction getRootDb(): RootDatabase {\n  if (!rootDb) {\n    if (!fullDbPath) {\n      throw new Error(`LMDB path is not set!`)\n    }\n    rootDb = open({\n      name: `root`,\n      path: fullDbPath,\n      compression: true,\n    })\n  }\n  return rootDb\n}\n\n/* eslint-disable @typescript-eslint/no-namespace */\ndeclare global {\n  namespace NodeJS {\n    // eslint-disable-next-line @typescript-eslint/naming-convention\n    interface Global {\n      __GATSBY_OPEN_LMDBS?: Map<string, ILmdbDatabases>\n    }\n  }\n}\n\nfunction getDatabases(): ILmdbDatabases {\n  if (!databases) {\n    // __GATSBY_OPEN_LMDBS tracks if we already opened given db in this process\n    // In `gatsby serve` case we might try to open it twice - once for engines\n    // and second to get access to `SitePage` nodes (to power trailing slashes\n    // redirect middleware). This ensure there is single instance within a process.\n    // Using more instances seems to cause weird random errors.\n    if (!globalThis.__GATSBY_OPEN_LMDBS) {\n      globalThis.__GATSBY_OPEN_LMDBS = new Map()\n    }\n    databases = globalThis.__GATSBY_OPEN_LMDBS.get(fullDbPath)\n    if (databases) {\n      return databases\n    }\n\n    const rootDb = getRootDb()\n    databases = {\n      nodes: rootDb.openDB({\n        name: `nodes`,\n        // FIXME: sharedStructuresKey breaks tests - probably need some cleanup for it on DELETE_CACHE\n        // sharedStructuresKey: Symbol.for(`structures`),\n        // @ts-ignore\n        cache: {\n          // expirer: false disables LRU part and only take care of WeakRefs\n          // this way we don't retain nodes strongly, but will continue to\n          // reuse them if they are loaded already\n          expirer: false,\n        },\n      }),\n      nodesByType: rootDb.openDB({\n        name: `nodesByType`,\n        dupSort: true,\n      }),\n      metadata: rootDb.openDB({\n        name: `metadata`,\n        useVersions: true,\n      }),\n      indexes: rootDb.openDB({\n        name: `indexes`,\n        // TODO: use dupSort when this is ready: https://github.com/DoctorEvidence/lmdb-store/issues/66\n        // dupSort: true\n      }),\n    }\n    globalThis.__GATSBY_OPEN_LMDBS.set(fullDbPath, databases)\n  }\n  return databases\n}\n\n/**\n * @deprecated\n */\nfunction getNodes(): Array<IGatsbyNode> {\n  // const start = performance.now()\n  const result = Array.from<IGatsbyNode>(iterateNodes())\n  // const timeTotal = performance.now() - start\n  // console.warn(\n  //   `getNodes() is deprecated, use iterateNodes() instead; ` +\n  //     `array length: ${result.length}; time(ms): ${timeTotal}`\n  // )\n  return result ?? []\n}\n\n/**\n * @deprecated\n */\nfunction getNodesByType(type: string): Array<IGatsbyNode> {\n  // const start = performance.now()\n  const result = Array.from<IGatsbyNode>(iterateNodesByType(type))\n  // const timeTotal = performance.now() - start\n  // console.warn(\n  //   `getNodesByType() is deprecated, use iterateNodesByType() instead; ` +\n  //     `array length: ${result.length}; time(ms): ${timeTotal}`\n  // )\n  return result ?? []\n}\n\nfunction iterateNodes(): GatsbyIterable<IGatsbyNode> {\n  // Additionally fetching items by id to leverage lmdb-store cache\n  const nodesDb = getDatabases().nodes\n  return new GatsbyIterable(\n    nodesDb\n      .getKeys({ snapshot: false })\n      .map(nodeId => (typeof nodeId === `string` ? getNode(nodeId) : undefined))\n      .filter(Boolean) as ArrayLikeIterable<IGatsbyNode>\n  )\n}\n\nfunction iterateNodesByType(type: string): GatsbyIterable<IGatsbyNode> {\n  const nodesByType = getDatabases().nodesByType\n  return new GatsbyIterable(\n    nodesByType\n      .getValues(type)\n      .map(nodeId => getNode(nodeId))\n      .filter(Boolean) as ArrayLikeIterable<IGatsbyNode>\n  )\n}\n\nfunction getNode(id: string): IGatsbyNode | undefined {\n  if (!id || preSyncDeletedNodeIdsCache.has(id)) {\n    return undefined\n  }\n\n  const { nodes } = getDatabases()\n  return nodes.get(id)\n}\n\nfunction getTypes(): Array<string> {\n  return getDatabases().nodesByType.getKeys({}).asArray\n}\n\nfunction countNodes(typeName?: string): number {\n  if (!typeName) {\n    const stats = getDatabases().nodes.getStats() as { entryCount: number }\n    return Math.max(\n      Number(stats.entryCount) - preSyncDeletedNodeIdsCache.size,\n      0\n    ) // FIXME: add -1 when restoring shared structures key\n  }\n\n  const { nodesByType } = getDatabases()\n  return nodesByType.getValuesCount(typeName)\n}\n\nasync function runQuery(args: IRunFilterArg): Promise<IQueryResult> {\n  if (process.env.GATSBY_EXPERIMENTAL_LMDB_INDEXES) {\n    return await doRunQuery({\n      datastore: lmdbDatastore,\n      databases: getDatabases(),\n      ...args,\n    })\n  }\n  return Promise.resolve(runFastFiltersAndSort(args))\n}\n\nlet lastOperationPromise: Promise<any> = Promise.resolve()\n\nfunction updateDataStore(action: ActionsUnion): void {\n  switch (action.type) {\n    case `DELETE_CACHE`: {\n      const dbs = getDatabases()\n      // Force sync commit\n      dbs.nodes.transactionSync(() => {\n        dbs.nodes.clearSync()\n        dbs.nodesByType.clearSync()\n        dbs.metadata.clearSync()\n        dbs.indexes.clearSync()\n      })\n      break\n    }\n    case `SET_PROGRAM`: {\n      // TODO: remove this when we have support for incremental indexes in lmdb\n      clearIndexes()\n      break\n    }\n    case `CREATE_NODE`:\n    case `DELETE_NODE`:\n    case `ADD_FIELD_TO_NODE`:\n    case `ADD_CHILD_NODE_TO_PARENT_NODE`:\n    case `MATERIALIZE_PAGE_MODE`: {\n      const dbs = getDatabases()\n      const operationPromise = Promise.all([\n        updateNodes(dbs.nodes, action),\n        updateNodesByType(dbs.nodesByType, action),\n      ])\n      lastOperationPromise = operationPromise\n\n      // if create is used in the same transaction as delete we should remove it from cache\n      if (action.type === `CREATE_NODE`) {\n        preSyncDeletedNodeIdsCache.delete(action.payload.id)\n      }\n\n      if (action.type === `DELETE_NODE` && action.payload?.id) {\n        preSyncDeletedNodeIdsCache.add(action.payload.id)\n        operationPromise.then(() => {\n          // only clear if no other operations have been done in the meantime\n          if (lastOperationPromise === operationPromise) {\n            preSyncDeletedNodeIdsCache.clear()\n          }\n        })\n      }\n    }\n  }\n}\n\nfunction clearIndexes(): void {\n  const dbs = getDatabases()\n  dbs.nodes.transactionSync(() => {\n    dbs.metadata.clearSync()\n    dbs.indexes.clearSync()\n  })\n}\n\n/**\n * Resolves when all the data is synced\n */\nasync function ready(): Promise<void> {\n  await lastOperationPromise\n}\n\nexport function setupLmdbStore({\n  dbPath = getDefaultDbPath(),\n}: { dbPath?: string } = {}): IDataStore {\n  fullDbPath = dbPath\n\n  replaceReducer({\n    nodes: (state = new Map(), action) =>\n      action.type === `DELETE_CACHE` ? new Map() : state,\n    nodesByType: (state = new Map(), action) =>\n      action.type === `DELETE_CACHE` ? new Map() : state,\n  })\n  emitter.on(`*`, action => {\n    if (action) {\n      updateDataStore(action)\n    }\n  })\n  // TODO: remove this when we have support for incremental indexes in lmdb\n  clearIndexes()\n  return lmdbDatastore\n}\n"],"file":"lmdb-datastore.js"}