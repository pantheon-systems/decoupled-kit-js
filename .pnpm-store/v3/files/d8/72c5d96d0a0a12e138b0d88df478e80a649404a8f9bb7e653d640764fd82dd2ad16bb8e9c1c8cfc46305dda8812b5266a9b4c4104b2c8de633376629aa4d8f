{"version":3,"sources":["../../../src/steps/preview/on-create-page.ts"],"names":["onCreatepageSavePreviewNodeIdToPageDependency","helpers","page","getNode","nodeThatCreatedThisPage","context","id","store","dispatch","previewStore","saveNodePageState","nodeId","path","updatedAt","onCreatePageRespondToPreviewStatusQuery","nodePageCreatedCallbacks","pagePathToNodeDependencyId","getState","Object","keys","length","nodeIdThatCreatedThisPage","nodePageCreatedCallback","unSubscribeToPagesCreatedFromNodeById","reporter","warn","__wpGatsbyNodeModified","pageCopy","modified","deletePage","createPage","actions","passedNode","pageNode","status"],"mappings":";;;;;;;AAAA;;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,MAAMA,6CAA6C,GACxDC,OAD2D,IAElD;AACT;AACA,MAAI,CAAC,sBAAL,EAAsB;AACpB;AACD;;AAED,QAAM;AAAEC,IAAAA,IAAF;AAAQC,IAAAA;AAAR,MAAoBF,OAA1B;AAEA,QAAMG,uBAAuB,GAC3BF,IAAI,CAACG,OAAL,IAAgBH,IAAI,CAACG,OAAL,CAAaC,EAA7B,IAAmCH,OAAO,CAACD,IAAI,CAACG,OAAL,CAAaC,EAAd,CAD5C;;AAGA,MAAIF,uBAAJ,EAA6B;AAC3BG,mBAAMC,QAAN,CAAeC,YAAf,CAA4BC,iBAA5B,CAA8C;AAC5CC,MAAAA,MAAM,EAAEP,uBAAuB,CAACE,EADY;AAE5CJ,MAAAA,IAAI,EAAE;AACJU,QAAAA,IAAI,EAAEV,IAAI,CAACU,IADP;AAEJC,QAAAA,SAAS,EAAEX,IAAI,CAACW;AAFZ;AAFsC,KAA9C;AAOD;AACF,CAtBM;AAwBP;AACA;AACA;AACA;AACA;AACA;;;;;AACO,MAAMC,uCAAuC,GAAG,MACrDb,OADqD,IAEnC;AAAA;;AAClB;AACA,MAAI,CAAC,sBAAL,EAAsB;AACpB;AACD;;AAED,QAAM;AAAEc,IAAAA,wBAAF;AAA4BC,IAAAA;AAA5B,MACJT,eAAMU,QAAN,GAAiBR,YADnB;;AAGA,QAAM;AAAEP,IAAAA,IAAF;AAAQC,IAAAA;AAAR,MAAoBF,OAA1B;;AAEA,MACE,CAACc,wBAAD,IACA,CAACG,MAAM,CAACC,IAAP,CAAYJ,wBAAZ,EAAsCK,MAFzC,EAGE;AACA;AACD;;AAED,QAAMC,yBAAyB,GAC7BL,0BAD6B,aAC7BA,0BAD6B,gDAC7BA,0BAA0B,CAAGd,IAAI,CAACU,IAAR,CADG,0DAC7B,sBAAyCD,MAD3C;;AAGA,MAAI,CAACU,yBAAL,EAAgC;AAC9B;AACD;;AAED,QAAMC,uBAAuB,GAC3BD,yBAAyB,IACzBN,wBAAwB,CAACM,yBAAD,CAF1B;;AAIA,MACE,CAACA,yBAAD,IACA,OAAOC,uBAAP,KAAoC,UAFtC,EAGE;AACA;AACD;;AAEDf,iBAAMC,QAAN,CAAeC,YAAf,CAA4Bc,qCAA5B,CAAkE;AAChEZ,IAAAA,MAAM,EAAEU;AADwD,GAAlE;;AAIA,QAAMjB,uBAAuB,GAAGD,OAAO,CAACkB,yBAAD,CAAvC;;AAEA,MAAI,CAACjB,uBAAL,EAA8B;AAC5BH,IAAAA,OAAO,CAACuB,QAAR,CAAiBC,IAAjB,CACE,wCACG,0EAAyEJ,yBAA0B,0BADtG,CADF;AAKA;AACD,GAjDiB,CAmDlB;AACA;;;AACA,MAAI,CAACnB,IAAI,CAACG,OAAL,CAAaqB,sBAAlB,EAA0C;AACxC,UAAMC,QAAQ,GAAG,EAAE,GAAGzB;AAAL,KAAjB;AACAyB,IAAAA,QAAQ,CAACtB,OAAT,CAAiBqB,sBAAjB,GAA0CtB,uBAAuB,CAACwB,QAAlE;AAEA,UAAM;AAAEC,MAAAA,UAAF;AAAcC,MAAAA;AAAd,QAA6B7B,OAAO,CAAC8B,OAA3C;AAEAF,IAAAA,UAAU,CAAC3B,IAAD,CAAV;AACA4B,IAAAA,UAAU,CAACH,QAAD,CAAV;AACD;;AAED,QAAML,uBAAuB,CAAC;AAC5BU,IAAAA,UAAU,EAAE5B,uBADgB;AAE5B6B,IAAAA,QAAQ,EAAE/B,IAFkB;AAG5BG,IAAAA,OAAO,EAAG,0CAHkB;AAI5B6B,IAAAA,MAAM,EAAG;AAJmB,GAAD,CAA7B;AAMD,CAvEM","sourcesContent":["import { formatLogMessage } from \"~/utils/format-log-message\"\nimport store from \"~/store\"\nimport { GatsbyNodeApiHelpers } from \"~/utils/gatsby-types\"\nimport { inPreviewMode } from \".\"\n\n/**\n * during onCreatePage we want to figure out which node the page is dependant on\nand then store that page in state so we can return info about the page to WordPress\nwhen the page is updated during Previews.\nWe do that by finding the node id on pageContext.id\nIdeally we could detect this without the need for pageContext.id.\nThere was an attempt to use store.componentDataDependencies but my implementation\nwas buggy and unreliable. @todo it's worth trying to remove the need for\npageContext.id again in the future.\n */\nexport const onCreatepageSavePreviewNodeIdToPageDependency = (\n  helpers: GatsbyNodeApiHelpers\n): void => {\n  // if we're not in preview mode we don't want to track this\n  if (!inPreviewMode()) {\n    return\n  }\n\n  const { page, getNode } = helpers\n\n  const nodeThatCreatedThisPage =\n    page.context && page.context.id && getNode(page.context.id)\n\n  if (nodeThatCreatedThisPage) {\n    store.dispatch.previewStore.saveNodePageState({\n      nodeId: nodeThatCreatedThisPage.id,\n      page: {\n        path: page.path,\n        updatedAt: page.updatedAt,\n      },\n    })\n  }\n}\n\n/**\n * during onCreatePage we check if the node this page was created from\n * has been updated and if it has a callback waiting for it\n * if both of those things are true we invoke the callback to\n * respond to the WP instance preview client\n */\nexport const onCreatePageRespondToPreviewStatusQuery = async (\n  helpers: GatsbyNodeApiHelpers\n): Promise<void> => {\n  // if we're not in preview mode we don't want to set this up\n  if (!inPreviewMode()) {\n    return\n  }\n\n  const { nodePageCreatedCallbacks, pagePathToNodeDependencyId } =\n    store.getState().previewStore\n\n  const { page, getNode } = helpers\n\n  if (\n    !nodePageCreatedCallbacks ||\n    !Object.keys(nodePageCreatedCallbacks).length\n  ) {\n    return\n  }\n\n  const nodeIdThatCreatedThisPage =\n    pagePathToNodeDependencyId?.[page.path]?.nodeId\n\n  if (!nodeIdThatCreatedThisPage) {\n    return\n  }\n\n  const nodePageCreatedCallback =\n    nodeIdThatCreatedThisPage &&\n    nodePageCreatedCallbacks[nodeIdThatCreatedThisPage]\n\n  if (\n    !nodeIdThatCreatedThisPage ||\n    typeof nodePageCreatedCallback !== `function`\n  ) {\n    return\n  }\n\n  store.dispatch.previewStore.unSubscribeToPagesCreatedFromNodeById({\n    nodeId: nodeIdThatCreatedThisPage,\n  })\n\n  const nodeThatCreatedThisPage = getNode(nodeIdThatCreatedThisPage)\n\n  if (!nodeThatCreatedThisPage) {\n    helpers.reporter.warn(\n      formatLogMessage(\n        `There was an attempt to call a Preview onPageCreated callback for node ${nodeIdThatCreatedThisPage}, but no node was found.`\n      )\n    )\n    return\n  }\n\n  // We need to add the modified time to pageContext so we can read it in WP\n  // This way can tell when the updated page has been deployed\n  if (!page.context.__wpGatsbyNodeModified) {\n    const pageCopy = { ...page }\n    pageCopy.context.__wpGatsbyNodeModified = nodeThatCreatedThisPage.modified\n\n    const { deletePage, createPage } = helpers.actions\n\n    deletePage(page)\n    createPage(pageCopy)\n  }\n\n  await nodePageCreatedCallback({\n    passedNode: nodeThatCreatedThisPage,\n    pageNode: page,\n    context: `onCreatePage Preview callback invocation`,\n    status: `PREVIEW_SUCCESS`,\n  })\n}\n"],"file":"on-create-page.js"}