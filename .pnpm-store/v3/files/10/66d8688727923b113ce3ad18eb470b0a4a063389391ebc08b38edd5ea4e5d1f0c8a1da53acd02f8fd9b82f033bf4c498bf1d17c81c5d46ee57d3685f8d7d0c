{"version":3,"sources":["../../src/utils/gatsby-webpack-stats-extractor.ts"],"names":["GatsbyWebpackStatsExtractor","constructor","plugin","name","apply","compiler","previousChunkMapJson","previousWebpackStatsJson","hooks","done","tapAsync","stats","assets","assetsMap","childAssets","chunkGroup","compilation","chunkGroups","files","chunk","chunks","push","filter","f","slice","length","map","filename","rel","childChunkGroups","Object","entries","getChildrenByOrders","moduleGraph","chunkGraph","childFiles","childChunkGroup","webpackStats","toJson","all","assetsByChunkName","childAssetsByChunkName","newChunkMapJson","JSON","stringify","fs","writeFile","path","join","newWebpackStatsJson"],"mappings":"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","sourcesContent":["import fs from \"fs-extra\"\nimport path from \"path\"\nimport { Compiler } from \"webpack\"\n\nexport class GatsbyWebpackStatsExtractor {\n  private plugin: { name: string }\n  constructor() {\n    this.plugin = { name: `GatsbyWebpackStatsExtractor` }\n  }\n  apply(compiler: Compiler): void {\n    let previousChunkMapJson: string | undefined\n    let previousWebpackStatsJson: string | undefined\n    compiler.hooks.done.tapAsync(this.plugin.name, async (stats, done) => {\n      const assets = {}\n      const assetsMap = {}\n      const childAssets = {}\n      for (const chunkGroup of stats.compilation.chunkGroups) {\n        if (chunkGroup.name) {\n          const files: Array<string> = []\n          for (const chunk of chunkGroup.chunks) {\n            files.push(...chunk.files)\n          }\n          assets[chunkGroup.name] = files.filter(f => f.slice(-4) !== `.map`)\n          assetsMap[chunkGroup.name] = files\n            .filter(\n              f =>\n                f.slice(-4) !== `.map` &&\n                f.slice(0, chunkGroup.name?.length) === chunkGroup.name\n            )\n            .map(filename => `/${filename}`)\n\n          for (const [rel, childChunkGroups] of Object.entries(\n            chunkGroup.getChildrenByOrders(\n              stats.compilation.moduleGraph,\n              stats.compilation.chunkGraph\n            )\n          )) {\n            if (!(chunkGroup.name in childAssets)) {\n              childAssets[chunkGroup.name] = {}\n            }\n\n            const childFiles: Array<string> = []\n            for (const childChunkGroup of childChunkGroups) {\n              for (const chunk of childChunkGroup.chunks) {\n                childFiles.push(...chunk.files)\n              }\n            }\n\n            childAssets[chunkGroup.name][rel] = childFiles\n          }\n        }\n      }\n\n      const webpackStats = {\n        ...stats.toJson({ all: false, chunkGroups: true }),\n        assetsByChunkName: assets,\n        childAssetsByChunkName: childAssets,\n      }\n\n      const newChunkMapJson = JSON.stringify(assetsMap)\n      if (newChunkMapJson !== previousChunkMapJson) {\n        await fs.writeFile(\n          path.join(`public`, `chunk-map.json`),\n          newChunkMapJson\n        )\n        previousChunkMapJson = newChunkMapJson\n      }\n\n      const newWebpackStatsJson = JSON.stringify(webpackStats)\n      if (newWebpackStatsJson !== previousWebpackStatsJson) {\n        await fs.writeFile(\n          path.join(`public`, `webpack.stats.json`),\n          newWebpackStatsJson\n        )\n        previousWebpackStatsJson = newWebpackStatsJson\n      }\n\n      done()\n    })\n  }\n}\n"],"file":"gatsby-webpack-stats-extractor.js"}