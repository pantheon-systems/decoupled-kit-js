{"version":3,"sources":["../../../src/utils/parcel/compile-gatsby-files.ts"],"names":["COMPILED_CACHE_DIR","PARCEL_CACHE_DIR","gatsbyFileRegex","constructParcel","siteRoot","Parcel","entries","defaultConfig","require","resolve","mode","targets","root","outputFormat","includeNodeModules","sourceMap","engines","node","distDir","cacheDir","compileGatsbyFiles","parcel","bundleGraph","run","telemetry","isTrackingEnabled","bundles","getBundles","length","compiledTSFilesCount","bundle","getMainEntry","filePath","endsWith","trackCli","valueInteger","name","error","diagnostics","handleErrors","reporter","panic","id","context","forEach","err","codeFrames","c","codeHighlightsMessage","codeHighlights","message","specificMessage","undefined","generalMessage","origin","hints","getResolvedFieldsForPlugin","rootDir","pluginName","resolvedCompiledGatsbyNode","findCompiledLocalPluginModule","moduleName","compiledPathForPlugin","compiledPathForModule","isCompiled"],"mappings":"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","sourcesContent":["import { Parcel } from \"@parcel/core\"\nimport type { Diagnostic } from \"@parcel/diagnostic\"\nimport reporter from \"gatsby-cli/lib/reporter\"\nimport { ensureDir, emptyDir, existsSync } from \"fs-extra\"\nimport telemetry from \"gatsby-telemetry\"\n\nexport const COMPILED_CACHE_DIR = `.cache/compiled`\nexport const PARCEL_CACHE_DIR = `.cache/.parcel-cache`\nexport const gatsbyFileRegex = `gatsby-+(node|config).ts`\n\n/**\n * Construct Parcel with config.\n * @see {@link https://parceljs.org/features/targets/}\n */\nexport function constructParcel(siteRoot: string): Parcel {\n  return new Parcel({\n    entries: [\n      `${siteRoot}/${gatsbyFileRegex}`,\n      `${siteRoot}/plugins/**/${gatsbyFileRegex}`,\n    ],\n    defaultConfig: require.resolve(`gatsby-parcel-config`),\n    mode: `production`,\n    targets: {\n      root: {\n        outputFormat: `commonjs`,\n        includeNodeModules: false,\n        sourceMap: false,\n        engines: {\n          node: `>= 14.15.0`,\n        },\n        distDir: `${siteRoot}/${COMPILED_CACHE_DIR}`,\n      },\n    },\n    cacheDir: `${siteRoot}/${PARCEL_CACHE_DIR}`,\n  })\n}\n\n/**\n * Compile known gatsby-* files (e.g. `gatsby-config`, `gatsby-node`)\n * and output in `<SITE_ROOT>/.cache/compiled`.\n */\nexport async function compileGatsbyFiles(siteRoot: string): Promise<void> {\n  try {\n    const parcel = constructParcel(siteRoot)\n    const distDir = `${siteRoot}/${COMPILED_CACHE_DIR}`\n    await ensureDir(distDir)\n    await emptyDir(distDir)\n    const { bundleGraph } = await parcel.run()\n\n    if (telemetry.isTrackingEnabled()) {\n      const bundles = bundleGraph.getBundles()\n\n      if (bundles.length === 0) return\n\n      let compiledTSFilesCount = 0\n      for (const bundle of bundles) {\n        if (bundle?.getMainEntry()?.filePath?.endsWith(`.ts`)) {\n          compiledTSFilesCount = compiledTSFilesCount + 1\n        }\n      }\n      telemetry.trackCli(`PARCEL_COMPILATION_END`, {\n        valueInteger: compiledTSFilesCount,\n        name: `count of compiled ts files`,\n      })\n    }\n  } catch (error) {\n    if (error.diagnostics) {\n      handleErrors(error.diagnostics)\n    } else {\n      reporter.panic({\n        id: `11903`,\n        error,\n        context: {\n          siteRoot,\n        },\n      })\n    }\n  }\n}\n\nfunction handleErrors(diagnostics: Array<Diagnostic>): void {\n  diagnostics.forEach(err => {\n    if (err.codeFrames) {\n      err.codeFrames.forEach(c => {\n        // Assuming that codeHighlights only ever has one entry in the array. Local tests only ever showed one\n        const codeHighlightsMessage = c?.codeHighlights[0]?.message\n        // If both messages are the same don't print the specific, otherwise they would be duplicate\n        const specificMessage =\n          codeHighlightsMessage === err.message\n            ? undefined\n            : codeHighlightsMessage\n        reporter.panic({\n          id: `11901`,\n          context: {\n            filePath: c?.filePath,\n            generalMessage: err.message,\n            specificMessage,\n            origin: err?.origin,\n            hints: err?.hints,\n          },\n        })\n      })\n    } else {\n      reporter.panic({\n        id: `11901`,\n        context: {\n          generalMessage: err.message,\n          origin: err?.origin,\n          hints: err?.hints,\n        },\n      })\n    }\n  })\n}\n\nexport function getResolvedFieldsForPlugin(\n  rootDir: string,\n  pluginName: string\n): {\n  resolvedCompiledGatsbyNode?: string\n} {\n  return {\n    resolvedCompiledGatsbyNode: findCompiledLocalPluginModule(\n      rootDir,\n      pluginName,\n      `gatsby-node`\n    ),\n  }\n}\n\nexport function findCompiledLocalPluginModule(\n  rootDir: string,\n  pluginName: string,\n  moduleName: \"gatsby-config\" | \"gatsby-node\"\n): string | undefined {\n  const compiledPathForPlugin =\n    pluginName === `default-site-plugin`\n      ? `${rootDir}/${COMPILED_CACHE_DIR}`\n      : `${rootDir}/${COMPILED_CACHE_DIR}/plugins/${pluginName}`\n\n  const compiledPathForModule = `${compiledPathForPlugin}/${moduleName}.js`\n\n  const isCompiled = existsSync(compiledPathForModule)\n  if (isCompiled) {\n    return compiledPathForModule\n  }\n\n  return undefined\n}\n"],"file":"compile-gatsby-files.js"}