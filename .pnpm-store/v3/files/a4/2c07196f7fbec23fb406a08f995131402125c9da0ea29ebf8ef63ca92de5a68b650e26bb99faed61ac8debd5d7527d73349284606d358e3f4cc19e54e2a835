{"version":3,"sources":["../../../../src/utils/worker/child/schema.ts"],"names":["setInferenceMetadata","buildSchema","workerStore","store","getState","config","pathPrefix","Error","schemaSnapshotPath","path","join","program","directory","fs","pathExists","schemaSnapshot","readFile","dispatch","actions","createTypes","fullMetadataBuild","parentSpan"],"mappings":";;;;;;;;AAAA;;AACA;;AAEA;;AACA;;AACA;;AACA;;AACA;;;;;;AAEO,SAASA,oBAAT,GAAsC;AAC3C,uBAAS,CAAE,mBAAF,CAAT;AACD;;AAEM,eAAeC,WAAf,GAA4C;AAAA;;AACjD,QAAMC,WAAW,GAAGC,aAAMC,QAAN,EAApB,CADiD,CAGjD;;;AACA,MAAI,0BAACF,WAAD,aAACA,WAAD,8CAACA,WAAW,CAAEG,MAAd,wDAAC,oBAAqBC,UAAtB,yEAAoC,IAApC,MAA8C,IAAlD,EAAwD;AACtD,UAAMC,KAAK,CACR,0EADQ,CAAX;AAGD;;AAED,QAAMC,kBAAkB,GAAGC,IAAI,CAACC,IAAL,CACzBR,WAAW,CAACS,OAAZ,CAAoBC,SADK,EAExB,QAFwB,EAGxB,YAHwB,CAA3B;;AAMA,MAAI,MAAMC,EAAE,CAACC,UAAH,CAAcN,kBAAd,CAAV,EAA6C;AAC3C,UAAMO,cAAc,GAAG,MAAMF,EAAE,CAACG,QAAH,CAAYR,kBAAZ,EAAiC,OAAjC,CAA7B;;AACAL,iBAAMc,QAAN,CAAeC,iBAAQC,WAAR,CAAoBJ,cAApB,CAAf;AACD;;AAEDf,EAAAA,oBAAoB;AAEpB,QAAM,4BAAe,2BAAf,CAAN,CAvBiD,CAyBjD;;AACA,QAAM,mBAAM;AAAEoB,IAAAA,iBAAiB,EAAE,KAArB;AAA4BC,IAAAA,UAAU,EAAE;AAAxC,GAAN,CAAN;AACD","sourcesContent":["import * as path from \"path\"\nimport * as fs from \"fs-extra\"\n\nimport { store } from \"../../../redux\"\nimport { actions } from \"../../../redux/actions\"\nimport { build } from \"../../../schema\"\nimport apiRunnerNode from \"../../api-runner-node\"\nimport { setState } from \"./state\"\n\nexport function setInferenceMetadata(): void {\n  setState([`inferenceMetadata`])\n}\n\nexport async function buildSchema(): Promise<void> {\n  const workerStore = store.getState()\n\n  // pathPrefix: '' will at least be defined when config is loaded\n  if ((workerStore?.config?.pathPrefix ?? null) === null) {\n    throw Error(\n      `Config loading didn't finish before attempting to build schema in worker`\n    )\n  }\n\n  const schemaSnapshotPath = path.join(\n    workerStore.program.directory,\n    `.cache`,\n    `schema.gql`\n  )\n\n  if (await fs.pathExists(schemaSnapshotPath)) {\n    const schemaSnapshot = await fs.readFile(schemaSnapshotPath, `utf-8`)\n    store.dispatch(actions.createTypes(schemaSnapshot))\n  }\n\n  setInferenceMetadata()\n\n  await apiRunnerNode(`createSchemaCustomization`)\n\n  // build() runs other lifecycles like \"createResolvers\" or \"setFieldsOnGraphQLNodeType\" internally\n  await build({ fullMetadataBuild: false, parentSpan: {} })\n}\n"],"file":"schema.js"}